<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tayan - –ü–µ—Ä–≤–∞—è –ø–æ–º–æ—â—å</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    

    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .app-container {
            width: 100%;
            max-width: 480px;
            height: 100vh;
            background: white;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(0,0,0,0.1);
        }

        .screen {
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            position: absolute;
            top: 0;
            left: 0;
        }

        .screen.active {
            display: flex;
        }

        .heading {
            font-family: 'Inter';
            color: #2C2D5F;
        }

        .bg-light { background: #F5F5F8; }
        .text-primary { color: #2C2D5F; }

        .header {
            background: #2C2D5F;
            padding: 24px;
            border-radius: 0 0 32px 32px;
            color: white;
        }

        .header-top {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
        }

        .back-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-size: 18px;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .header-title {
            font-family: 'Inter';
            font-size: 20px;
            color: white;
            flex: 1;
        }

        .btn {
            padding: 16px 24px;
            border-radius: 12px;
            border: none;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: #2C2D5F;
            color: white;
        }

        .btn-primary:hover {
            background: #1f1f4d;
        }

        .btn-danger {
            background: #B91717;
            color: white;
        }

        .btn-danger:hover {
            background: #9a1414;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #2C2D5F;
            color: #2C2D5F;
        }

        .btn-outline:hover {
            background: rgba(44,45,95,0.1);
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            color: #2C2D5F;
            font-weight: 600;
        }

        .input-field, .textarea-field {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e5e5;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
        }

        .input-field:focus, .textarea-field:focus {
            outline: none;
            border-color: #2C2D5F;
        }

        .textarea-field {
            resize: vertical;
            min-height: 100px;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .category-card {
            background: linear-gradient(135deg, #fff, #f5f5f5);
            padding: 24px;
            border-radius: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-height: 160px;
            transition: transform 0.3s;
        }

        .category-card:hover {
            transform: translateY(-4px);
        }

        .category-icon {
            width: 64px;
            height: 64px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .content.bg-light {
            background: #F5F5F8;
        }

        .bottom-nav {
            background: white;
            border-top: 1px solid #e5e5e5;
            padding: 16px 24px;
            display: flex;
            justify-content: center;
        }

        .splash-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 24px;
            padding: 48px;
        }

        .auth-header {
            background: #2C2D5F;
            padding: 64px 32px 48px;
            border-radius: 0 0 40px 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .auth-header.white {
            background: white;
        }

        .auth-form {
            padding: 48px 32px;
            flex: 1;
        }

        .auth-form.blue {
            background: #2C2D5F;
        }

        .auth-form.blue .input-label {
            color: white;
        }

        .auth-form.blue .input-field {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.2);
            color: white;
        }

        .auth-link {
            text-align: center;
            margin-top: 24px;
            color: #666;
            font-size: 14px;
        }

        .auth-link span {
            color: #2C2D5F;
            cursor: pointer;
            text-decoration: underline;
        }

        .sos-btn {
            width: 100%;
            background: linear-gradient(135deg, #E57373, #EF5350);
            color: white;
            padding: 24px;
            border-radius: 16px;
            border: none;
            font-family: 'Inter';
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(185,23,23,0.3);
        }

        .section-title {
            font-family: 'Inter';
            font-size: 18px;
            color: #2C2D5F;
            margin-bottom: 16px;
        }

        .function-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .function-item {
            background: white;
            padding: 16px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }

        .function-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            transform: translateX(4px);
        }

        .function-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: #F5F5F8;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .map-container {
            height: 256px;
            position: relative;
            background: #e5e5e5;
            overflow: hidden;
        }

        .map-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }

        .zoom-controls {
            position: absolute;
            bottom: 16px;
            right: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .zoom-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: white;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
        }

        .zoom-btn:hover {
            background: #f5f5f5;
        }

        .volunteer-card {
            background: white;
            border: 2px solid #e5e5e5;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .video-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.3s;
        }

        .video-card:hover {
            transform: translateY(-4px);
        }

        .vm-stack{
            display:flex;
            flex-direction:column;
            gap:12px;
        }

            .vm-card{
            background:#fff;
            border:1px solid #e5e5e5;
            border-radius:14px;
            padding:12px;
        }

            .vm-card h4{
            margin:0 0 8px 0;
            color:#2C2D5F;
            font-weight:800;
            font-size:14px;
        }

            .vm-card p{
            margin:0;
        }

            .vm-muted{
            color:#666;
            font-size:14px;
            line-height:1.5;
            white-space:pre-line;
        }




        .video-thumbnail {
            height: 128px;
            position: relative;
        }

        .alert-box {
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .volunteer-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .badge {
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }

        .badge.blue {
            background: #E3F2FD;
            border: 1px solid #90CAF9;
            color: #1565C0;
        }

        .badge.green {
            background: #E8F5E9;
            border: 1px solid #A5D6A7;
            color: #2E7D32;
        }

        .badge.gray {
            background: #F5F5F8;
            border: 1px solid #e5e5e5;
            color: #2C2D5F;
        }

        .volunteer-actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }

        .icon-btn {
            width: 30px;
            height: 44px;
            border-radius: 12px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .icon-btn.primary {
            background: #2C2D5F;
            color: white;
            border: none;
        }

        .icon-btn.outline {
            background: white;
            color: #2C2D5F;
            border: 2px solid #2C2D5F;
        }

        .volunteer-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #E3E6FF;
            color: #2C2D5F;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            flex-shrink: 0;
        }



        .alert-box.info {
            background: #E3F2FD;
            border: 1px solid #90CAF9;
            color: #1565C0;
        }

        .alert-box.danger {
            background: #FFEBEE;
            border: 2px solid #EF9A9A;
            color: #B71C1C;
        }

        .step-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .step-item {
            display: flex;
            gap: 16px;
            background: #F5F5F8;
            padding: 16px;
            border-radius: 12px;
        }

        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #2C2D5F;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Inter';
            flex-shrink: 0;
        }

        .review-card {
            background: white;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-message {
            padding: 12px 16px;
            border-radius: 16px;
            max-width: 80%;
            font-size: 14px;
            line-height: 1.5;
        }

        .chat-message.bot {
            background: #f5f5f5;
            color: #2C2D5F;
            align-self: flex-start;
        }

        .chat-message.user {
            background: #2C2D5F;
            color: white;
            align-self: flex-end;
        }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 28px;
            background: #ddd;
            border-radius: 14px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #66BB6A;
        }

        .card {
            box-shadow: 0 6px 16px rgba(0,0,0,0.06);
        }


        .toggle-slider {
            position: absolute;
            top: 4px;
            left: 4px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(20px);
        }

        .language-option {
            background: white;
            padding: 16px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s;
            margin-bottom: 12px;
        }

        .language-option:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .language-option.selected {
            border: 2px solid #2C2D5F;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .mb-3 { margin-bottom: 12px; }
        .mb-6 { margin-bottom: 24px; }

        @media (max-width: 480px) {
            .app-container {
                max-width: 100%;
                box-shadow: none;
            }
        }
        @media (max-width: 480px) {
    .auth-form {
        padding: 24px 16px; 
    }

    .auth-form input,
    .auth-form button {
        font-size: 14px; 
    }

    .auth-link {
        font-size: 12px;
    }
}

#vmLeaflet {
  width: 100%;
  height: 100%;
}

.leaflet-container {
  background: #e5e5e5;
  outline: none;
}




    </style>
</head>
<body>
    <div id="app" class="app-container"></div>

    <script>

        (function () {
            const r = window.location.reload.bind(window.location);
            window.location.reload = (...args) => {
                console.warn("LOCATION.RELOAD called");
                console.trace("RELOAD TRACE");
                return r(...args);
            };

            const a = window.location.assign.bind(window.location);
            window.location.assign = (url) => {
                console.warn("LOCATION.ASSIGN:", url);
                console.trace("ASSIGN TRACE");
                return a(url);
            };

            const p = window.location.replace.bind(window.location);
            window.location.replace = (url) => {
                console.warn("LOCATION.REPLACE:", url);
                console.trace("REPLACE TRACE");
                return p(url);
            };

            window.addEventListener("submit", (e) => {
                console.warn("FORM SUBMIT CAPTURED:", e.target);
                console.trace("SUBMIT TRACE");
            }, true);

            window.addEventListener("click", (e) => {
                const link = e.target.closest("a");
                if (link) {
                console.warn("LINK CLICK:", link.href);
                console.trace("LINK TRACE");
                }
            }, true);
            })();



        
        const appState = {
            currentScreen: 'splash',
            userName: '',
            userEmail: '',
            userPhone: '',
            userRole: "user",
            mapZoom: 1,
            selectedCategory: '',
            selectedVideoId: 0,
            selectedRequestId: 0,
            selectedVolunteerRequestId: 0,
            selectedVolunteerId: 0,
            selectedVolunteerName: "",
            selectedLanguage: 'ru',
            hasActiveRequest: false,
            activeRequestStatus: "",
            notifications: {
                sos: true,
                volunteers: true,
                updates: false
            },
            chatMessages: []
        };

        const API_BASE = "http://127.0.0.1:8000";
        document.addEventListener("submit", (e) => {
            console.warn("GLOBAL SUBMIT BLOCKED", e.target?.id || e.target);
            e.preventDefault();
            e.stopPropagation();
        }, true);

        console.log("BOOT:", Date.now(), "navigation type:", performance.getEntriesByType("navigation")[0]?.type);

        window.addEventListener("beforeunload", () => {
            console.log("BEFOREUNLOAD fired (page reload/close)");
        });


        function setToken(t) { localStorage.setItem("token", t); }
        function getToken() { return localStorage.getItem("token") || ""; }
        function setSelectedRequestId(id) {
            const rid = Number(id) || 0;
            appState.selectedRequestId = rid;
            localStorage.setItem("selectedRequestId", String(rid));
        }

        function loadSelectedRequestId() {
            const v = localStorage.getItem("selectedRequestId");
            const rid = Number(v) || 0;
            appState.selectedRequestId = rid;
            return rid;
        }

        function clearSelectedRequestId() {
            appState.selectedRequestId = 0;
            localStorage.removeItem("selectedRequestId");
        }

        function clearToken() { localStorage.removeItem("token"); }
        let pollInFlight = false;
        let splashTimer = null;
        let vmMap = null;
        let vmUserMarker = null;
        let vmVolMarker = null;
        let vmLastFitKey = "";
        let volGeoTimer = null;
        let userMarker = null;
        let volunteerMarker = null;
        let vmRoute = null;
        let vmRouteKey = "";
        let userEtaTimer = null;
        let hmMap = null;
        let hmUserMarker = null;
        let hmHospitalLayer = null;
        let homeRefreshLock = false;







        



        async function api(path, method="GET", body=null, auth=false) {
            const url = `http://127.0.0.1:8000${path}`;
            const headers = {};

            if (body !== null) headers["Content-Type"] = "application/json";
            if (auth) headers["Authorization"] = "Bearer " + localStorage.getItem("token");

            const res = await fetch(url, {
                method,
                headers,
                body: body === null ? null : JSON.stringify(body)
            });

            const text = await res.text();
            let data = null;
            try { data = text ? JSON.parse(text) : null; } catch { data = text; }

            if (!res.ok) {
                console.error("API ERROR", res.status, data);
                throw new Error((data && data.detail) ? data.detail : `HTTP ${res.status}`);
            }
            return data;
            }

        function getGeo() {
                return new Promise((resolve) => {
                    if (!navigator.geolocation) {
                        resolve({ lat: null, lng: null });
                        return;
                    }
                    navigator.geolocation.getCurrentPosition(
                        (pos) => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
                        () => resolve({ lat: null, lng: null }),
                        { enableHighAccuracy: true, timeout: 8000, maximumAge: 60000 }
                    );
                });
        }
        async function requireGeo(message = "–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏") {
            const geo = await getGeo();
            if (geo.lat == null || geo.lng == null) {
                alert(message);
                return null;
            }
            return geo;
        }






        
        const botResponses = {
            '–ø—Ä–∏–≤–µ—Ç': '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ß–µ–º –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å?',
            '–ø–æ–º–æ—â—å': '–Ø –º–æ–≥—É –ø–æ–º–æ—á—å –≤–∞–º —Å:\n‚Ä¢ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º —Å–∏–º–ø—Ç–æ–º–æ–≤\n‚Ä¢ –ü–µ—Ä–≤–æ–π –ø–æ–º–æ—â—å—é\n‚Ä¢ –ü–æ–∏—Å–∫–æ–º –±–ª–∏–∂–∞–π—à–∏—Ö –±–æ–ª—å–Ω–∏—Ü\n‚Ä¢ –í—ã–∑–æ–≤–æ–º –≤–æ–ª–æ–Ω—Ç–µ—Ä–æ–≤',
            '—Å–∏–º–ø—Ç–æ–º—ã': '–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –≤–∞—Å –±–µ—Å–ø–æ–∫–æ–∏—Ç? –û–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ —Å–∏–º–ø—Ç–æ–º—ã –ø–æ–¥—Ä–æ–±–Ω–µ–µ.',
            '—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞': '–ü—Ä–∏ –≤—ã—Å–æ–∫–æ–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ:\n1. –ò–∑–º–µ—Ä—å—Ç–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É\n2. –ü–µ–π—Ç–µ –º–Ω–æ–≥–æ –∂–∏–¥–∫–æ—Å—Ç–∏\n3. –ü—Ä–∏–º–∏—Ç–µ –∂–∞—Ä–æ–ø–æ–Ω–∏–∂–∞—é—â–µ–µ\n4. –ü—Ä–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ –≤—ã—à–µ 39¬∞C –≤—ã–∑–æ–≤–∏—Ç–µ –≤—Ä–∞—á–∞',
            '–≥–æ–ª–æ–≤–∞': '–ü—Ä–∏ –≥–æ–ª–æ–≤–Ω–æ–π –±–æ–ª–∏:\n1. –û—Ç–¥–æ—Ö–Ω–∏—Ç–µ –≤ —Ç–∏—Ö–æ–º —Ç–µ–º–Ω–æ–º –º–µ—Å—Ç–µ\n2. –í—ã–ø–µ–π—Ç–µ –≤–æ–¥—ã\n3. –ü—Ä–∏–º–∏—Ç–µ –æ–±–µ–∑–±–æ–ª–∏–≤–∞—é—â–µ–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏\n4. –ï—Å–ª–∏ –±–æ–ª—å —Å–∏–ª—å–Ω–∞—è –∏–ª–∏ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç - –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –≤—Ä–∞—á—É',
            '–¥–∞–≤–ª–µ–Ω–∏–µ': '–ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –¥–∞–≤–ª–µ–Ω–∏–µ–º:\n1. –ü—Ä–∏—Å—è–¥—å—Ç–µ –∏–ª–∏ –ø—Ä–∏–ª—è–≥—Ç–µ\n2. –ò–∑–º–µ—Ä—å—Ç–µ –¥–∞–≤–ª–µ–Ω–∏–µ\n3. –ü—Ä–∏–º–∏—Ç–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–æ–µ –ª–µ–∫–∞—Ä—Å—Ç–≤–æ\n4. –ü—Ä–∏ —Å–∏–ª—å–Ω–æ–º –Ω–µ–¥–æ–º–æ–≥–∞–Ω–∏–∏ –≤—ã–∑–æ–≤–∏—Ç–µ —Å–∫–æ—Ä—É—é',
            '–æ–∂–æ–≥': '–ü—Ä–∏ –æ–∂–æ–≥–µ:\n1. –û—Ö–ª–∞–¥–∏—Ç–µ –º–µ—Å—Ç–æ –æ–∂–æ–≥–∞ –≤–æ–¥–æ–π 10-20 –º–∏–Ω—É—Ç\n2. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–µ–¥ –∏–ª–∏ –º–∞—Å–ª–æ\n3. –ù–∞–ª–æ–∂–∏—Ç–µ —Å—Ç–µ—Ä–∏–ª—å–Ω—É—é –ø–æ–≤—è–∑–∫—É\n4. –ü—Ä–∏ —Å–∏–ª—å–Ω–æ–º –æ–∂–æ–≥–µ –≤—ã–∑–æ–≤–∏—Ç–µ —Å–∫–æ—Ä—É—é',
            '–ø–æ—Ä–µ–∑': '–ü—Ä–∏ –ø–æ—Ä–µ–∑–µ:\n1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏–µ —á–∏—Å—Ç–æ–π —Ç–∫–∞–Ω—å—é\n2. –ü—Ä–æ–º–æ–π—Ç–µ —Ä–∞–Ω—É –≤–æ–¥–æ–π\n3. –û–±—Ä–∞–±–æ—Ç–∞–π—Ç–µ –∞–Ω—Ç–∏—Å–µ–ø—Ç–∏–∫–æ–º\n4. –ù–∞–ª–æ–∂–∏—Ç–µ —Å—Ç–µ—Ä–∏–ª—å–Ω—É—é –ø–æ–≤—è–∑–∫—É',
            '—Å–∫–æ—Ä–∞—è': '–ù–æ–º–µ—Ä —Å–∫–æ—Ä–æ–π –ø–æ–º–æ—â–∏: 103 –∏–ª–∏ 112\n–¢–∞–∫–∂–µ –≤—ã –º–æ–∂–µ—Ç–µ –≤—ã–∑–≤–∞—Ç—å –≤–æ–ª–æ–Ω—Ç–µ—Ä–∞ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É SOS –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.',
            '—Å–ø–∞—Å–∏–±–æ': '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞! –í—Å–µ–≥–¥–∞ —Ä–∞–¥ –ø–æ–º–æ—á—å. –ë–µ—Ä–µ–≥–∏—Ç–µ —Å–µ–±—è! üíô',
            'default': '–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª –≤–∞—à –≤–æ–ø—Ä–æ—Å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–ø—Ä–æ—Å–∏—Ç—å –æ:\n‚Ä¢ –°–∏–º–ø—Ç–æ–º–∞—Ö (—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, –≥–æ–ª–æ–≤–Ω–∞—è –±–æ–ª—å, –¥–∞–≤–ª–µ–Ω–∏–µ)\n‚Ä¢ –ü–µ—Ä–≤–æ–π –ø–æ–º–æ—â–∏ (–æ–∂–æ–≥, –ø–æ—Ä–µ–∑)\n‚Ä¢ –í—ã–∑–æ–≤–µ –ø–æ–º–æ—â–∏\n\n–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É SOS –¥–ª—è —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π –ø–æ–º–æ—â–∏.'
        };

        
        const categoriesData = {
            'heart-attack': {
                title: '–°–µ—Ä–¥–µ—á–Ω—ã–π –ø—Ä–∏—Å—Ç—É–ø',
                icon: '‚ù§Ô∏è',
                color: '#FFCDD2',
                steps: [
                    '–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –≤—ã–∑–æ–≤–∏—Ç–µ —Å–∫–æ—Ä—É—é –ø–æ–º–æ—â—å (103 –∏–ª–∏ 112)',
                    '–ü–æ–º–æ–≥–∏—Ç–µ —á–µ–ª–æ–≤–µ–∫—É —Å–µ—Å—Ç—å –≤ —É–¥–æ–±–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ',
                    '–†–∞—Å—Å—Ç–µ–≥–Ω–∏—Ç–µ —Ç–µ—Å–Ω—É—é –æ–¥–µ–∂–¥—É, –æ–±–µ—Å–ø–µ—á—å—Ç–µ –¥–æ—Å—Ç—É–ø —Å–≤–µ–∂–µ–≥–æ –≤–æ–∑–¥—É—Ö–∞',
                    '–î–∞–π—Ç–µ –∞—Å–ø–∏—Ä–∏–Ω (–µ—Å–ª–∏ –Ω–µ—Ç –∞–ª–ª–µ—Ä–≥–∏–∏) –∏ –Ω–∏—Ç—Ä–æ–≥–ª–∏—Ü–µ—Ä–∏–Ω –ø–æ–¥ —è–∑—ã–∫',
                    '–£—Å–ø–æ–∫–æ–π—Ç–µ –ø–æ—Å—Ç—Ä–∞–¥–∞–≤—à–µ–≥–æ, –Ω–µ –æ—Å—Ç–∞–≤–ª—è–π—Ç–µ –µ–≥–æ –æ–¥–Ω–æ–≥–æ',
                    '–ë—É–¥—å—Ç–µ –≥–æ—Ç–æ–≤—ã –∫ —Å–µ—Ä–¥–µ—á–Ω–æ-–ª–µ–≥–æ—á–Ω–æ–π —Ä–µ–∞–Ω–∏–º–∞—Ü–∏–∏'
                ]
            },
            'burns': {
                title: '–û–∂–æ–≥–∏',
                icon: 'üî•',
                color: '#FFE0B2',
                steps: [
                    '–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–µ–∫—Ä–∞—Ç–∏—Ç–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –æ–∂–æ–≥–∞',
                    '–û—Ö–ª–∞–¥–∏—Ç–µ –ø–æ—Ä–∞–∂–µ–Ω–Ω—ã–π —É—á–∞—Å—Ç–æ–∫ –ø—Ä–æ—Ö–ª–∞–¥–Ω–æ–π –≤–æ–¥–æ–π 10-20 –º–∏–Ω—É—Ç',
                    '–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–µ–¥, –º–∞—Å–ª–æ –∏–ª–∏ –º–∞–∑–∏!',
                    '–ê–∫–∫—É—Ä–∞—Ç–Ω–æ —Å–Ω–∏–º–∏—Ç–µ —É–∫—Ä–∞—à–µ–Ω–∏—è –¥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è –æ—Ç–µ–∫–∞',
                    '–ù–∞–ª–æ–∂–∏—Ç–µ —Å—Ç–µ—Ä–∏–ª—å–Ω—É—é –ø–æ–≤—è–∑–∫—É',
                    '–ü—Ä–∏ —Å–∏–ª—å–Ω—ã—Ö –æ–∂–æ–≥–∞—Ö –≤—ã–∑–æ–≤–∏—Ç–µ —Å–∫–æ—Ä—É—é –ø–æ–º–æ—â—å'
                ]
            },
            'cuts': {
                title: '–ü–æ—Ä–µ–∑—ã –∏ —Ä–∞–Ω—ã',
                icon: 'ü©π',
                color: '#F8BBD0',
                steps: [
                    '–í—ã–º–æ–π—Ç–µ —Ä—É–∫–∏ –ø–µ—Ä–µ–¥ –æ–∫–∞–∑–∞–Ω–∏–µ–º –ø–æ–º–æ—â–∏',
                    '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏–µ, –ø—Ä–∏–∂–∞–≤ —á–∏—Å—Ç—É—é —Ç–∫–∞–Ω—å –∫ —Ä–∞–Ω–µ',
                    '–ü—Ä–æ–º–æ–π—Ç–µ —Ä–∞–Ω—É —á–∏—Å—Ç–æ–π –≤–æ–¥–æ–π',
                    '–û–±—Ä–∞–±–æ—Ç–∞–π—Ç–µ –∫—Ä–∞—è —Ä–∞–Ω—ã –∞–Ω—Ç–∏—Å–µ–ø—Ç–∏–∫–æ–º',
                    '–ù–∞–ª–æ–∂–∏—Ç–µ —Å—Ç–µ—Ä–∏–ª—å–Ω—É—é –ø–æ–≤—è–∑–∫—É',
                    '–ü—Ä–∏ –≥–ª—É–±–æ–∫–∏—Ö —Ä–∞–Ω–∞—Ö –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –≤—Ä–∞—á—É'
                ]
            },
            'electric-shock': {
                title: '–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–π —à–æ–∫',
                icon: '‚ö°',
                color: '#FFF9C4',
                steps: [
                    '–ù–ï –ü–†–ò–ö–ê–°–ê–ô–¢–ï–°–¨ –∫ –ø–æ—Å—Ç—Ä–∞–¥–∞–≤—à–µ–º—É, –ø–æ–∫–∞ –Ω–µ –æ—Ç–∫–ª—é—á–µ–Ω —Ç–æ–∫!',
                    '–û—Ç–∫–ª—é—á–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫ —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–∞',
                    '–í—ã–∑–æ–≤–∏—Ç–µ —Å–∫–æ—Ä—É—é –ø–æ–º–æ—â—å (103 –∏–ª–∏ 112)',
                    '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥—ã—Ö–∞–Ω–∏–µ –∏ –ø—É–ª—å—Å',
                    '–ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –Ω–∞—á–Ω–∏—Ç–µ —Å–µ—Ä–¥–µ—á–Ω–æ-–ª–µ–≥–æ—á–Ω—É—é —Ä–µ–∞–Ω–∏–º–∞—Ü–∏—é',
                    '–û–±—Ä–∞–±–æ—Ç–∞–π—Ç–µ –æ–∂–æ–≥–∏ –æ—Ç —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–∞'
                ]
            },
            'fever': {
                title: '–í—ã—Å–æ–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞',
                icon: 'üå°Ô∏è',
                color: '#BBDEFB',
                steps: [
                    '–ò–∑–º–µ—Ä—å—Ç–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É —Ç–µ–ª–∞',
                    '–û–±–µ—Å–ø–µ—á—å—Ç–µ –æ–±–∏–ª—å–Ω–æ–µ –ø–∏—Ç—å–µ',
                    '–°–Ω–∏–º–∏—Ç–µ –ª–∏—à–Ω—é—é –æ–¥–µ–∂–¥—É',
                    '–ü—Ä–æ—Ç—Ä–∏—Ç–µ —Ç–µ–ª–æ —Ç–µ–ø–ª–æ–π –≤–æ–¥–æ–π',
                    '–î–∞–π—Ç–µ –∂–∞—Ä–æ–ø–æ–Ω–∏–∂–∞—é—â–µ–µ (–ø–∞—Ä–∞—Ü–µ—Ç–∞–º–æ–ª –∏–ª–∏ –∏–±—É–ø—Ä–æ—Ñ–µ–Ω)',
                    '–ü—Ä–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ –≤—ã—à–µ 39¬∞C –∏–ª–∏ —Å—É–¥–æ—Ä–æ–≥–∞—Ö –≤—ã–∑–æ–≤–∏—Ç–µ —Å–∫–æ—Ä—É—é'
                ]
            },
            'poisoning': {
                title: '–û—Ç—Ä–∞–≤–ª–µ–Ω–∏–µ',
                icon: '‚ö†Ô∏è',
                color: '#E1BEE7',
                steps: [
                    '–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –≤—ã–∑–æ–≤–∏—Ç–µ —Å–∫–æ—Ä—É—é –ø–æ–º–æ—â—å (103)',
                    '–û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫ –æ—Ç—Ä–∞–≤–ª–µ–Ω–∏—è',
                    '–ù–ï –≤—ã–∑—ã–≤–∞–π—Ç–µ —Ä–≤–æ—Ç—É –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –≤—Ä–∞—á–∞!',
                    '–ü—Ä–∏ –æ—Ç—Ä–∞–≤–ª–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ —Ä–æ—Ç - –¥–∞–π—Ç–µ –≤—ã–ø–∏—Ç—å –≤–æ–¥—ã',
                    '–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —É–ø–∞–∫–æ–≤–∫—É –≤–µ—â–µ—Å—Ç–≤–∞ –¥–ª—è –≤—Ä–∞—á–µ–π',
                    '–°–ª–µ–¥–∏—Ç–µ –∑–∞ –¥—ã—Ö–∞–Ω–∏–µ–º –∏ —Å–æ–∑–Ω–∞–Ω–∏–µ–º –ø–æ—Å—Ç—Ä–∞–¥–∞–≤—à–µ–≥–æ'
                ]
            }
        };

        const videosData = [
            { id: 1, title: '–ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ –æ–∂–æ–≥–µ?', duration: '5:32', color: '#FF6B6B' },
            { id: 2, title: '–ö–∞–∫ –ø–æ–º–æ—á—å –ø—Ä–∏ –æ–±–º–æ—Ä–æ–∫–µ?', duration: '4:15', color: '#4ECDC4' },
            { id: 3, title: '–ü–µ—Ä–≤–∞—è –ø–æ–º–æ—â—å –ø—Ä–∏ –ø–µ—Ä–µ–ª–æ–º–µ', duration: '6:48', color: '#95E1D3' },
            { id: 4, title: '–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏—è', duration: '5:20', color: '#F38181' },
            { id: 5, title: '–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–µ –¥—ã—Ö–∞–Ω–∏–µ', duration: '7:12', color: '#AA96DA' },
            { id: 6, title: '–ü–æ–º–æ—â—å –ø—Ä–∏ –æ—Ç—Ä–∞–≤–ª–µ–Ω–∏–∏', duration: '5:55', color: '#FCBAD3' }
        ];

        const reviewsData = [
            {
                name: '–ê–ª–∏–Ω–∞ –°—É–ª–∞–π–º–∞–Ω–æ–≤–∞',
                date: '10 –Ω–æ—è–±—Ä—è 2025',
                rating: 5,
                text: '–í–æ–ª–æ–Ω—Ç–µ—Ä –ø—Ä–∏–µ—Ö–∞–ª –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ! –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ –æ–∫–∞–∑–∞–ª –ø–µ—Ä–≤—É—é –ø–æ–º–æ—â—å. –û–≥—Ä–æ–º–Ω–æ–µ —Å–ø–∞—Å–∏–±–æ!',
                volunteer: '–≠–º–∏–ª—å –¢–æ–∫—Ç–æ–≥—É–ª–æ–≤'
            },
            {
                name: '–ë–∞–∫—Ç—ã–≥—É–ª –ê—Å–∞–Ω–æ–≤–∞',
                date: '8 –Ω–æ—è–±—Ä—è 2025',
                rating: 5,
                text: '–û—Ç–ª–∏—á–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ! –ü–æ–º–æ–≥–ª–∏ –º–æ–µ–π –º–∞–º–µ –ø—Ä–∏ —Å–µ—Ä–¥–µ—á–Ω–æ–º –ø—Ä–∏—Å—Ç—É–ø–µ. –í—Ä–∞—á –ø—Ä–∏–µ—Ö–∞–ª –∑–∞ 5 –º–∏–Ω—É—Ç.',
                volunteer: '–ê–π–≥—É–ª—å –ê—Å–∞–Ω–æ–≤–∞'
            },
            {
                name: '–¢–∏–º—É—Ä –î–∂—É–º–∞–±–∞–µ–≤',
                date: '5 –Ω–æ—è–±—Ä—è 2025',
                rating: 4,
                text: '–•–æ—Ä–æ—à–∞—è —Ä–∞–±–æ—Ç–∞ –≤–æ–ª–æ–Ω—Ç–µ—Ä–∞. –ë—ã—Å—Ç—Ä–æ —Å–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–ª—Å—è –∏ –æ–∫–∞–∑–∞–ª –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –ø–æ–º–æ—â—å.',
                volunteer: '–ú–∞—Ä–∞—Ç –ë–µ–∫–±–æ–ª–æ—Ç–æ–≤'
            },
            {
                name: '–ù—É—Ä–≥—É–ª—å –ú–æ–ª–¥–æ—à–µ–≤–∞',
                date: '3 –Ω–æ—è–±—Ä—è 2025',
                rating: 5,
                text: '–°–ø–∞—Å–∏–±–æ –æ–≥—Ä–æ–º–Ω–æ–µ! –î–æ—á–∫–µ —Å—Ç–∞–ª–æ –ø–ª–æ—Ö–æ, –≤–æ–ª–æ–Ω—Ç–µ—Ä –ø—Ä–∏–µ—Ö–∞–ª–∞ –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ –∏ –ø–æ–º–æ–≥–ª–∞ –¥–æ –ø—Ä–∏–µ–∑–¥–∞ —Å–∫–æ—Ä–æ–π.',
                volunteer: '–ì—É–ª—å–Ω–∞—Ä–∞ –¢–æ–∫—Ç–æ–º—É—à–µ–≤–∞'
            },
            {
                name: '–ê–∑–∞–º–∞—Ç –°—ã–¥—ã–∫–æ–≤',
                date: '1 –Ω–æ—è–±—Ä—è 2025',
                rating: 5,
                text: '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥, –±—ã—Å—Ç—Ä–∞—è —Ä–µ–∞–∫—Ü–∏—è. –†–µ–∫–æ–º–µ–Ω–¥—É—é –≤—Å–µ–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ!',
                volunteer: '–≠–º–∏–ª—å –¢–æ–∫—Ç–æ–≥—É–ª–æ–≤'
            }
        ];

        
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem("token");


            if (token) {
                try {
                const me = await api("/auth/me", "GET", null, true);
                appState.userName = me.name;
                appState.userEmail = me.email || "";
                appState.userPhone = me.phone;
                appState.userRole = me.role || "user";
                } catch (e) {
                localStorage.removeItem("token");
                }
            }

            loadSelectedRequestId();


            appState.chatMessages.push({
                type: 'bot',
                text: '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø AI-–ø–æ–º–æ—â–Ω–∏–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Tayan. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?'
            });

            appState.chatMessages.push({
                type: 'bot',
                text: '–Ø –º–æ–≥—É:\n‚Ä¢ –ü–æ–º–æ—á—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–∏–º–ø—Ç–æ–º—ã\n‚Ä¢ –ü–æ–¥—Å–∫–∞–∑–∞—Ç—å –ø–µ—Ä–≤—ã–µ —à–∞–≥–∏ –ø–æ–º–æ—â–∏\n‚Ä¢ –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –∑–¥–æ—Ä–æ–≤—å–µ'
            });

            const lastScreen = sessionStorage.getItem("lastScreen") || "";
            const savedReqId = parseInt(sessionStorage.getItem("selectedRequestId") || "0", 10);

            if (savedReqId) appState.selectedRequestId = savedReqId;

            const canRestore =
            token &&
            lastScreen &&
            !["splash","auth","login"].includes(lastScreen);

            if (canRestore) {
            appState.currentScreen = lastScreen;
            renderScreen(lastScreen);
            } else {
            renderScreen("splash");
            if (splashTimer) clearTimeout(splashTimer);
            splashTimer = setTimeout(() => {
                if (appState.currentScreen === "splash") {
                navigateTo(token ? "home" : "auth", "splash timeout");
                }
            }, 2000);
            }
        });


        
        function navigateTo(screen, reason = "") {
            if (splashTimer) {
                clearTimeout(splashTimer);
                splashTimer = null;
            }


            const prev = appState.currentScreen;

            console.log("NAVIGATE:", prev, "‚Üí", screen, "reason:", reason, "time:", fmtLocal(new Date()));
            console.trace("NAVIGATE TRACE");

            stopPolling();
            stopVolunteerGeo();
            stopUserEta();



            appState.currentScreen = screen;

            sessionStorage.setItem("lastScreen", screen);
            sessionStorage.setItem("selectedRequestId", String(appState.selectedRequestId || 0));

            if (prev === "volunteer-map" && screen !== "volunteer-map") {
            if (vmMap) {
                vmMap.remove();
                vmMap = null;
                vmUserMarker = null;
                vmVolMarker = null;
                vmLastFitKey = "";
            }
        }

        if (prev === "map" && screen !== "map") {
            if (hmMap) {
                hmMap.remove();
                hmMap = null;
                hmUserMarker = null;
                hmHospitalLayer = null;
            }
        }


        renderScreen(screen);

        }






        
        function renderScreen(screen) {
            const app = document.getElementById('app');
            const screens = {
                splash: renderSplash,
                auth: renderAuth,
                login: renderLogin,
                home: renderHome,
                "volunteer-open": renderVolunteerOpen,
                profile: renderProfile,
                settings: renderSettings,
                notifications: renderNotifications,
                language: renderLanguage,
                privacy: renderPrivacy,
                help: renderHelp,
                myRequests: renderMyRequests,
                requestDetail: renderRequestDetail,
                "volunteer-my": renderVolunteerMy,
                "volunteer-request": renderVolunteerRequest,
                "volunteer-profile": renderVolunteerProfile,
                categories: renderCategories,
                'category-detail': renderCategoryDetail,
                video: renderVideo,
                'video-detail': renderVideoDetail,
                map: renderMap,
                'volunteer-map': renderVolunteerMap,
                chat: renderChat,
                reviews: renderReviews,
                'symptom-form': renderSymptomForm
                
            };
            
            if (screens[screen]) {
                app.innerHTML = screens[screen]();
                attachEvents(screen);
            }
        }

        
        function renderSplash() {
            return `
                <div class="screen active splash-screen">
                    <img src="logo2-removebg-preview.png" alt="Tayan Logo" style="width: 200px; height: 200px; object-fit: contain;">
                    <p style="text-align: center; color: #666; font-size: 14px;">–ü–µ—Ä–≤–∞—è –ø–æ–º–æ—â—å, –∫–æ–≥–¥–∞ –≤–∞–∂–Ω–∞ –∫–∞–∂–¥–∞—è —Å–µ–∫—É–Ω–¥–∞</p>
                </div>
            `;
        }

        
        function renderAuth() {
            return `
                <div class="screen active" style="background: #2C2D5F;">
                <div class="auth-header white">
                    <img src="logo2-removebg-preview.png" alt="Tayan Logo" style="width: 130px; height: 150px; object-fit: contain;">
                    <h1 class="heading" style="color: #2C2D5F;">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h1>
                </div>

                <div class="auth-form blue">
                    <div id="authBox">
                    <div class="input-group">
                        <label class="input-label">–ò–º—è</label>
                        <input type="text" id="name" class="input-field" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è" required>
                    </div>

                    <div class="input-group">
                        <label class="input-label">Email</label>
                        <input type="email" id="email" class="input-field" placeholder="example@mail.com" required>
                    </div>

                    <div class="input-group">
                        <label class="input-label">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                        <input type="tel" id="phone" class="input-field" placeholder="+996 XXX XXX XXX" required>
                    </div>

                    <div class="input-group">
                        <label class="input-label">–ö—Ç–æ –≤—ã?</label>
                        <select id="role" class="input-field" required>
                        <option value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                        <option value="volunteer">–í–æ–ª–æ–Ω—Ç—ë—Ä</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label class="input-label">–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" id="password" class="input-field" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required>
                    </div>

                    <button type="button" id="btnRegister" class="btn btn-danger" style="width: 100%;">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                    </div>

                    <p class="auth-link" style="color: rgba(255,255,255,0.7);">
                    –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <span onclick="navigateTo('login')" style="color: white;">–í–æ–π—Ç–∏</span>
                    </p>
                </div>
                </div>
            `;
        }


        
        function renderLogin() {
            return `
                <div class="screen active">
                <div class="auth-header">
                    <img src="tayan_logo.jpg" alt="Tayan Logo" style="width: 385px; height: 385px; border-radius:20%; object-fit: cover;">
                    <h1 class="header-title">–í—Ö–æ–¥</h1>
                </div>

                <div class="auth-form">
                    <div id="loginBox">
                    <div class="input-group">
                        <label class="input-label">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                        <input type="tel" id="loginPhone" class="input-field" placeholder="+996 XXX XXX XXX" required>
                    </div>

                    <div class="input-group">
                        <label class="input-label">–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" id="loginPassword" class="input-field" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required>
                    </div>

                    <button type="button" id="btnLogin" class="btn btn-danger" style="width: 100%;">–í–æ–π—Ç–∏</button>
                    </div>

                    <p class="auth-link">
                    –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <span onclick="navigateTo('auth')">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</span>
                    </p>
                </div>
                </div>
            `;
        }

        async function fetchActiveRequestForMe() {
            if (appState.userRole === "volunteer") {
                const list = await api("/volunteer/my", "GET", null, true);
                return list.find(x => x.status === "accepted" || x.status === "in_progress") || null;
            } else {
                const list = await api("/requests/my", "GET", null, true);
                return list.find(x => x.status === "new" || x.status === "accepted" || x.status === "in_progress") || null;
            }
        }




        
        function renderHome() {
            const rid = Number(appState.selectedRequestId || loadSelectedRequestId() || 0);

            const canShowMyMap = !!(rid && (appState.hasActiveRequest || appState.activeRequestStatus));

            return `
                <div class="screen active bg-light">
                <div class="header">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <p style="color: rgba(255,255,255,0.6); font-size: 14px;">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ,</p>
                        <h2 style="font-family: 'Inter'; font-size: 20px; color: white;">${appState.userName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</h2>
                    </div>
                    <div onclick="navigateTo('profile')" style="width: 48px; height: 48px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer;">üë§</div>
                    </div>
                    
                    <button type="button" class="sos-btn" onclick="showSOS()">üö® –≠–ö–°–¢–†–ï–ù–ù–ê–Ø –ü–û–ú–û–©–¨ (SOS)</button>
                </div>
                
                <div class="content">
                    <h3 class="section-title">–ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø</h3>
                    
                    <div class="card-grid mb-6">
                    <div class="category-card" onclick="navigateTo('symptom-form')" style="background: linear-gradient(135deg, #FFE0B2, #FFECB3);">
                        <div class="category-icon" style="background: rgba(255,152,0,0.2);">ü©π</div>
                        <span style="text-align: center; font-weight: 600; color: #2C2D5F;">–õ–µ–≥–∫–æ–µ<br>–ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ</span>
                    </div>
                    
                    <div class="category-card" onclick="navigateTo('symptom-form')" style="background: linear-gradient(135deg, #FFF9C4, #FFFDE7);">
                        <div class="category-icon" style="background: rgba(255,235,59,0.3);">‚ö†Ô∏è</div>
                        <span style="text-align: center; font-weight: 600; color: #2C2D5F;">–ù–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ–µ<br>—Å–æ—Å—Ç–æ—è–Ω–∏–µ</span>
                    </div>
                    </div>
                    
                    <h3 class="section-title">–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏</h3>

                    <div class="function-list">
                    ${canShowMyMap ? `
                        <div class="function-item" onclick="openMyActiveMap()">
                        <div class="function-icon">üìç</div>
                        <span style="flex: 1; font-weight: 600; color: #2C2D5F;">–ú–æ—è –∞–∫—Ç–∏–≤–Ω–∞—è –∑–∞—è–≤–∫–∞ / –ö–∞—Ä—Ç–∞</span>
                        <span style="background:#E3F2FD;color:#1565C0;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;">
                            ${appState.activeRequestStatus || "active"}
                        </span>
                        <span>‚Ä∫</span>
                        </div>
                    ` : `
                        <div class="function-item" style="opacity:.45; pointer-events:none;">
                        <div class="function-icon">üìç</div>
                        <span style="flex: 1; font-weight: 600; color: #2C2D5F;">–ê–∫—Ç–∏–≤–Ω–æ–π –∑–∞—è–≤–∫–∏ –Ω–µ—Ç</span>
                        <span style="font-size:12px;color:#666;">‚Äî</span>
                        </div>
                    `}

                    ${appState.userRole === "volunteer" ? `
                        <div class="function-item" onclick="navigateTo('volunteer-open')">
                        <div class="function-icon">üßë‚Äç‚öïÔ∏è</div>
                        <span style="flex: 1; font-weight: 600; color: #2C2D5F;">–û—Ç–∫—Ä—ã—Ç—ã–µ –∑–∞—è–≤–∫–∏</span>
                        <span>‚Ä∫</span>
                        </div>

                        <div class="function-item" onclick="navigateTo('volunteer-my')">
                        <div class="function-icon">üìå</div>
                        <span style="flex: 1; font-weight: 600; color: #2C2D5F;">–ú–æ–∏ –ø—Ä–∏–Ω—è—Ç—ã–µ –∑–∞—è–≤–∫–∏</span>
                        <span>‚Ä∫</span>
                        </div>
                    ` : ""}

                    <div class="function-item" onclick="navigateTo('categories')">
                        <div class="function-icon">üìã</div>
                        <span style="flex: 1; font-weight: 600; color: #2C2D5F;">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–º–æ—â–∏</span>
                        <span>‚Ä∫</span>
                    </div>
                    
                    <div class="function-item" onclick="navigateTo('video')">
                        <div class="function-icon">üìπ</div>
                        <span style="flex: 1; font-weight: 600; color: #2C2D5F;">–í–∏–¥–µ–æ-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</span>
                        <span>‚Ä∫</span>
                    </div>
                    
                    <div class="function-item" onclick="navigateTo('map')">
                        <div class="function-icon">üó∫Ô∏è</div>
                        <span style="flex: 1; font-weight: 600; color: #2C2D5F;">–ö–∞—Ä—Ç–∞ –±–æ–ª—å–Ω–∏—Ü</span>
                        <span>‚Ä∫</span>
                    </div>
                    
                    <div class="function-item" onclick="navigateTo('chat')">
                        <div class="function-icon">üí¨</div>
                        <span style="flex: 1; font-weight: 600; color: #2C2D5F;">AI-–ø–æ–º–æ—â–Ω–∏–∫</span>
                        <span>‚Ä∫</span>
                    </div>
                    
                    <div class="function-item" onclick="navigateTo('reviews')">
                        <div class="function-icon">‚≠ê</div>
                        <span style="flex: 1; font-weight: 600; color: #2C2D5F;">–û—Ç–∑—ã–≤—ã –≤–æ–ª–æ–Ω—Ç–µ—Ä–æ–≤</span>
                        <span>‚Ä∫</span>
                    </div>

                    <div class="function-item" onclick="navigateTo('myRequests')">
                        <div class="function-icon">üìÑ</div>
                        <span style="flex: 1; font-weight: 600; color: #2C2D5F;">–ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è</span>
                        <span>‚Ä∫</span>
                    </div>
                    </div>
                </div>
                
                <div class="bottom-nav">
                    <div style="display: flex; flex-direction: column; align-items: center; color: #2C2D5F;">
                    <span style="font-size: 24px;">üè†</span>
                    <span style="font-size: 12px; font-weight: 600;">–ì–ª–∞–≤–Ω–∞—è</span>
                    </div>
                </div>
                </div>
            `;
        }


        function renderHomeActiveBlock() {
        if (appState.hasActiveRequest) {
            return `
            <div class="function-item" onclick="openMyActiveMap()">
                <div class="function-icon">üìç</div>
                <span style="flex: 1; font-weight: 600; color: #2C2D5F;">–ú–æ—è –∞–∫—Ç–∏–≤–Ω–∞—è –∑–∞—è–≤–∫–∞ / –ö–∞—Ä—Ç–∞</span>
                <span style="background:#E3F2FD;color:#1565C0;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;">
                ${appState.activeRequestStatus}
                </span>
                <span>‚Ä∫</span>
            </div>
            `;
        }

        return `
            <div class="function-item" style="opacity:.45; pointer-events:none;">
            <div class="function-icon">üìç</div>
            <span style="flex: 1; font-weight: 600; color: #2C2D5F;">–ê–∫—Ç–∏–≤–Ω–æ–π –∑–∞—è–≤–∫–∏ –Ω–µ—Ç</span>
            <span style="font-size:12px;color:#666;">‚Äî</span>
            </div>
        `;
        }

        async function loadVolunteerOpen() {
            const list = await api("/requests/open", "GET", null, true);

            const box = document.getElementById("volOpenList");
            const st = document.getElementById("volOpenStatus");

            if (st) st.innerHTML = `<div class="alert-box info">–û—Ç–∫—Ä—ã—Ç—ã—Ö –∑–∞—è–≤–æ–∫: ${list.length}</div>`;

            if (!box) return;

            if (!list.length) {
                box.innerHTML = `<div class="card">–°–µ–π—á–∞—Å –Ω–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∑–∞—è–≤–æ–∫.</div>`;
                return;
            }

            box.innerHTML = list.map(r => `
                <div class="card mb-3">
                    <div style="display:flex; justify-content:space-between; gap:10px; margin-bottom:8px;">
                        <div style="flex:1;">
                            <div style="font-weight:800;color:#2C2D5F;">
                                ${r.kind === "sos" ? "üö® SOS" : "ü©π –°–∏–º–ø—Ç–æ–º—ã"} ‚Ä¢ #${r.id}
                            </div>
                            <div style="color:#666;font-size:13px;">
                                ${fmtLocal(r.created_at)}
                            </div>
                        </div>
                        <span style="background:#FFF3E0;color:#E65100;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:800;height:fit-content;">
                            ${r.status}
                        </span>
                    </div>

                    ${r.address ? `<div style="color:#555;font-size:13px;margin-bottom:8px;">üìç ${r.address}</div>` : ``}
                    ${r.symptoms ? `<div style="color:#555;font-size:13px;margin-bottom:8px;"><strong>–°–∏–º–ø—Ç–æ–º—ã:</strong> ${r.symptoms}</div>` : ``}
                    ${r.comments ? `<div style="color:#777;font-size:13px;margin-bottom:8px;"><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${r.comments}</div>` : ``}

                    <button class="btn btn-primary" style="width:100%;"
                        onclick="acceptOpenRequest(${r.id})">
                        ‚úÖ –ü—Ä–∏–Ω—è—Ç—å –∑–∞—è–≤–∫—É
                    </button>
                </div>
            `).join("");
        }

        async function loadVolunteerMy() {
            const list = await api("/volunteer/my", "GET", null, true);

            const box = document.getElementById("volMyList");
            const st = document.getElementById("volMyStatus");

            if (st) st.innerHTML = `<div class="alert-box info">–ú–æ–∏—Ö –∑–∞—è–≤–æ–∫: ${list.length}</div>`;

            if (!box) return;

            if (!list.length) {
                box.innerHTML = `<div class="card">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–∏–Ω—è—Ç—ã—Ö –∑–∞—è–≤–æ–∫.</div>`;
                return;
            }

            box.innerHTML = list.map(r => `
                <div class="card mb-3" onclick="openVolunteerRequest(${r.id})" style="cursor:pointer;">
                    <div style="display:flex; justify-content:space-between; gap:10px; margin-bottom:8px;">
                        <div style="flex:1;">
                            <div style="font-weight:800;color:#2C2D5F;">
                                ${r.kind === "sos" ? "üö® SOS" : "ü©π –°–∏–º–ø—Ç–æ–º—ã"} ‚Ä¢ #${r.id}
                            </div>
                            <div style="color:#666;font-size:13px;">
                                ${fmtLocal(r.created_at)}
                            </div>
                        </div>
                        <span style="background:#E8F5E9;color:#2E7D32;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:800;height:fit-content;">
                            ${r.status}
                        </span>
                    </div>

                    ${r.address ? `<div style="color:#555;font-size:13px;margin-bottom:8px;">üìç ${r.address}</div>` : ``}

                    <div style="display:flex; gap:8px;">
                        <button class="btn btn-outline" style="flex:1;"
                            onclick="event.stopPropagation(); openVolunteerRequest(${r.id});">
                            üìÑ –û—Ç–∫—Ä—ã—Ç—å
                        </button>
                        <button class="btn btn-primary" style="flex:1;"
                            onclick="event.stopPropagation(); setSelectedRequestId(${r.id}); navigateTo('volunteer-map');">
                            üó∫Ô∏è –ö–∞—Ä—Ç–∞
                        </button>
                    </div>
                </div>
            `).join("");
        }






        function renderVolunteerOpen() {
            return `
                <div class="screen active bg-light">
                    <div class="header">
                        <button class="back-btn" onclick="navigateTo('home')">‚Üê</button>
                        <h2 style="color:white;margin:0;">–û—Ç–∫—Ä—ã—Ç—ã–µ –∑–∞—è–≤–∫–∏</h2>
                    </div>

                    <div class="content">
                        <div id="volOpenStatus"></div>
                        <div id="volOpenList"></div>
                    </div>
                </div>
            `;
        }


        function renderVolunteerMy() {
            return `
                <div class="screen active bg-light">
                    <div class="header">
                        <button class="back-btn" onclick="navigateTo('home')">‚Üê</button>
                        <h2 style="color:white;margin:0;">–ú–æ–∏ –∑–∞—è–≤–∫–∏</h2>
                    </div>

                    <div class="content">
                        <div id="volMyStatus"></div>
                        <div id="volMyList"></div>
                    </div>
                </div>
            `;
        }

        

        function renderVolunteerRequest() {
            return `
                <div class="screen active bg-light">
                    <div class="header">
                        <div class="header-top">
                            <button class="back-btn" onclick="navigateTo('volunteer-my')">‚Üê</button>
                            <h1 class="header-title">–ó–∞—è–≤–∫–∞</h1>
                        </div>
                    </div>
                    <div class="content">
                        <div id="volunteerRequestBox" class="card">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                </div>
            `;
        }

        function renderVolunteerProfile() {
            return `
                <div class="screen active bg-light">
                    <div class="header">
                        <div class="header-top">
                            <button class="back-btn" onclick="navigateTo('reviews')">‚Üê</button>
                            <h1 class="header-title">${appState.selectedVolunteerName || "–ü—Ä–æ—Ñ–∏–ª—å"}</h1>
                        </div>
                    </div>

                    <div class="content">
                        <div id="volunteerHeader" class="card mb-3">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è...</div>
                        <h3 class="section-title">–û—Ç–∑—ã–≤—ã</h3>
                        <div id="volunteerReviewsList" class="function-list"></div>
                    </div>
                </div>
            `;
        }




        
        function renderProfile() {
            return `
                <div class="screen active">
                    <div class="header">
                        <div class="header-top">
                            <button class="back-btn" onclick="navigateTo('home')">‚Üê</button>
                            <h1 class="header-title">–ü—Ä–æ—Ñ–∏–ª—å</h1>
                            <button class="back-btn" onclick="navigateTo('settings')">‚öôÔ∏è</button>
                        </div>
                        
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 16px;">
                            <div style="width: 96px; height: 96px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 42px;">üë§</div>
                            <h2 style="font-family: "Inter"; color: white;">${appState.userName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</h2>
                        </div>
                    </div>
                    
                    <div class="content">
                        <div class="card mb-3">
                            <div style="display: flex; gap: 16px; align-items: center;">
                                <div class="function-icon">üìß</div>
                                <div>
                                    <p style="color: #999; font-size: 12px;">Email</p>
                                    <p class="text-primary">${appState.userEmail || 'email@example.com'}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div style="display: flex; gap: 16px; align-items: center;">
                                <div class="function-icon">üì±</div>
                                <div>
                                    <p style="color: #999; font-size: 12px;">–¢–µ–ª–µ—Ñ–æ–Ω</p>
                                    <p class="text-primary">${appState.userPhone || '+996 XXX XXX XXX'}</p>
                                </div>
                            </div>
                        </div>
                        
                        <button class="btn btn-outline" style="width: 100%; margin-top: 24px; border-color: #B91717; color: #B91717;" onclick="logout()">
                            –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
                        </button>
                    </div>
                </div>
            `;
        }

        
        function renderSettings() {
            return `
                <div class="screen active">
                    <div class="header">
                        <div class="header-top">
                            <button class="back-btn" onclick="navigateTo('profile')">‚Üê</button>
                            <h1 class="header-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
                        </div>
                    </div>
                    
                    <div class="content">
                        <div class="function-list">
                            <div class="function-item" onclick="navigateTo('notifications')">
                                <div class="function-icon">üîî</div>
                                <div style="flex: 1;">
                                    <p style="font-weight: 600; color: #2C2D5F;">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</p>
                                    <p style="color: #666; font-size: 12px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</p>
                                </div>
                                <span>‚Ä∫</span>
                            </div>
                            
                            <div class="function-item" onclick="navigateTo('language')">
                                <div class="function-icon">üåê</div>
                                <div style="flex: 1;">
                                    <p style="font-weight: 600; color: #2C2D5F;">–Ø–∑—ã–∫</p>
                                    <p style="color: #666; font-size: 12px;">–†—É—Å—Å–∫–∏–π</p>
                                </div>
                                <span>‚Ä∫</span>
                            </div>

                            <div class="function-item" onclick="navigateTo('privacy')">
                                <div class="function-icon">üîí</div>
                                <div style="flex: 1;">
                                    <p style="font-weight: 600; color: #2C2D5F;">–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</p>
                                    <p style="color: #666; font-size: 12px;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏</p>
                                </div>
                                <span>‚Ä∫</span>
                            </div>

                            <div class="function-item" onclick="navigateTo('help')">
                                <div class="function-icon">‚ùì</div>
                                <div style="flex: 1;">
                                    <p style="font-weight: 600; color: #2C2D5F;">–ü–æ–º–æ—â—å</p>
                                    <p style="color: #666; font-size: 12px;">FAQ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞</p>
                                </div>
                                <span>‚Ä∫</span>
                            </div>
                        </div>
                        
                        <button class="btn btn-outline" style="width: 100%; margin-top: 24px; border-color: #B91717; color: #B91717;" onclick="logout()">
                            –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
                        </button>
                        
                        <p style="text-align: center; color: #999; font-size: 12px; margin-top: 24px;">–í–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è 1.0.0</p>
                    </div>
                </div>
            `;
        }

        
        function renderNotifications() {
            return `
                <div class="screen active">
                    <div class="header">
                        <div class="header-top">
                            <button class="back-btn" onclick="navigateTo('settings')">‚Üê</button>
                            <h1 class="header-title">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h1>
                        </div>
                    </div>
                    
                    <div class="content">
                        <div class="alert-box info">
                            üí° <strong>–í–∞–∂–Ω–æ:</strong> –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –æ—Å—Ç–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è SOS –≤–∫–ª—é—á–µ–Ω–Ω—ã–º–∏ –¥–ª—è —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤.
                        </div>

                        <div class="function-list">
                            <div class="function-item" onclick="toggleNotification('sos')">
                                <div class="function-icon">üö®</div>
                                <div style="flex: 1;">
                                    <p style="font-weight: 600; color: #2C2D5F;">–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (SOS)</p>
                                    <p style="color: #666; font-size: 12px;">–í–∞–∂–Ω—ã–µ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è –æ –ø–æ–º–æ—â–∏</p>
                                </div>
                                <div class="toggle-switch ${appState.notifications.sos ? 'active' : ''}" id="toggle-sos">
                                    <div class="toggle-slider"></div>
                                </div>
                            </div>
                            
                            <div class="function-item" onclick="toggleNotification('volunteers')">
                                <div class="function-icon">üë•</div>
                                <div style="flex: 1;">
                                    <p style="font-weight: 600; color: #2C2D5F;">–í–æ–ª–æ–Ω—Ç–µ—Ä—ã</p>
                                    <p style="color: #666; font-size: 12px;">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≤–æ–ª–æ–Ω—Ç–µ—Ä–∞—Ö</p>
                                </div>
                                <div class="toggle-switch ${appState.notifications.volunteers ? 'active' : ''}" id="toggle-volunteers">
                                    <div class="toggle-slider"></div>
                                </div>
                            </div>

                            <div class="function-item" onclick="toggleNotification('updates')">
                                <div class="function-icon">üì¢</div>
                                <div style="flex: 1;">
                                    <p style="font-weight: 600; color: #2C2D5F;">–û–±–Ω–æ–≤–ª–µ–Ω–∏—è</p>
                                    <p style="color: #666; font-size: 12px;">–ù–æ–≤–æ—Å—Ç–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</p>
                                </div>
                                <div class="toggle-switch ${appState.notifications.updates ? 'active' : ''}" id="toggle-updates">
                                    <div class="toggle-slider"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        
        function renderLanguage() {
            const languages = [
                { code: 'ru', name: '–†—É—Å—Å–∫–∏–π', flag: 'RU' },
                { code: 'kg', name: '–ö—ã—Ä–≥—ã–∑—á–∞', flag: 'KG' },
                { code: 'en', name: 'English', flag: 'EN' }
            ];

            return `
                <div class="screen active">
                    <div class="header">
                        <div class="header-top">
                            <button class="back-btn" onclick="navigateTo('settings')">‚Üê</button>
                            <h1 class="header-title">–Ø–∑—ã–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h1>
                        </div>
                    </div>
                    
                    <div class="content">
                        ${languages.map(lang => `
                            <div class="language-option ${appState.selectedLanguage === lang.code ? 'selected' : ''}" onclick="selectLanguage('${lang.code}')">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <span style="font-size: 32px;">${lang.flag}</span>
                                    <span style="font-weight: 600; color: #2C2D5F;">${lang.name}</span>
                                </div>
                                ${appState.selectedLanguage === lang.code ? '<span style="color: #2C2D5F; font-size: 20px;">‚úì</span>' : ''}
                            </div>
                        `).join('')}
                        
                        <div class="alert-box info" style="margin-top: 24px;">
                            üí° <strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong> –ò–∑–º–µ–Ω–µ–Ω–∏–µ —è–∑—ã–∫–∞ –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–æ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
                        </div>
                    </div>
                </div>
            `;
        }

        
        function renderPrivacy() {
            return `
                <div class="screen active">
                    <div class="header">
                        <div class="header-top">
                            <button class="back-btn" onclick="navigateTo('settings')">‚Üê</button>
                            <h1 class="header-title">–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å</h1>
                        </div>
                    </div>
                    
                    <div class="content">
                        <h3 class="section-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏</h3>
                        
                        <div class="function-list">
                            <div class="function-item">
                                <div class="function-icon">üìç</div>
                                <div style="flex: 1;">
                                    <p style="font-weight: 600; color: #2C2D5F;">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</p>
                                    <p style="color: #666; font-size: 12px;">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–º–æ—â–∏</p>
                                </div>
                                <div class="toggle-switch active">
                                    <div class="toggle-slider"></div>
                                </div>
                            </div>
                            
                            <div class="function-item">
                                <div class="function-icon">üìä</div>
                                <div style="flex: 1;">
                                    <p style="font-weight: 600; color: #2C2D5F;">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</p>
                                    <p style="color: #666; font-size: 12px;">–ü–æ–º–æ–≥–∞–µ—Ç —É–ª—É—á—à–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</p>
                                </div>
                                <div class="toggle-switch">
                                    <div class="toggle-slider"></div>
                                </div>
                            </div>
                        </div>

                        <h3 class="section-title" style="margin-top: 32px;">–î–æ–∫—É–º–µ–Ω—Ç—ã</h3>
                        
                        <div class="function-list">
                            <div class="function-item">
                                <div class="function-icon">üìÑ</div>
                                <span style="flex: 1; font-weight: 600; color: #2C2D5F;">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</span>
                                <span>‚Ä∫</span>
                            </div>
                            
                            <div class="function-item">
                                <div class="function-icon">üìã</div>
                                <span style="flex: 1; font-weight: 600; color: #2C2D5F;">–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</span>
                                <span>‚Ä∫</span>
                            </div>
                        </div>

                        <div class="alert-box danger" style="margin-top: 24px;">
                            <strong>‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</strong><br>
                            –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å. –í—Å–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ —É–¥–∞–ª–µ–Ω—ã.
                            <button class="btn btn-outline" style="width: 100%; margin-top: 12px; border-color: #B91717; color: #B91717;" onclick="alert('–§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö')">
                                –£–¥–∞–ª–∏—Ç—å –º–æ–∏ –¥–∞–Ω–Ω—ã–µ
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        
        function renderHelp() {
            const faqItems = [
                {
                    question: '–ö–∞–∫ –≤—ã–∑–≤–∞—Ç—å –≤–æ–ª–æ–Ω—Ç–µ—Ä–∞?',
                    answer: '–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫—Ä–∞—Å–Ω—É—é –∫–Ω–æ–ø–∫—É SOS –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ "–õ–µ–≥–∫–æ–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ" / "–ù–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ" –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É.'
                },
                {
                    question: '–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –ø–æ–º–æ—â—å –≤–æ–ª–æ–Ω—Ç–µ—Ä–∞?',
                    answer: '–ü–æ–º–æ—â—å –≤–æ–ª–æ–Ω—Ç–µ—Ä–æ–≤ –∞–±—Å–æ–ª—é—Ç–Ω–æ –±–µ—Å–ø–ª–∞—Ç–Ω–∞. –≠—Ç–æ –≤–æ–ª–æ–Ω—Ç–µ—Ä—Å–∫–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è, —Ü–µ–ª—å –∫–æ—Ç–æ—Ä–æ–π - –ø–æ–º–æ—á—å –ª—é–¥—è–º –≤ —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö.'
                },
                {
                    question: '–ö–∞–∫ —Å—Ç–∞—Ç—å –≤–æ–ª–æ–Ω—Ç–µ—Ä–æ–º?',
                    answer: '–°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É +996 555 000 000 –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞ email: volunteer@tayan.kg'
                },
                {
                    question: '–†–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞?',
                    answer: '–û—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø–µ—Ä–≤–æ–π –ø–æ–º–æ—â–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –æ—Ñ–ª–∞–π–Ω, –Ω–æ –¥–ª—è –≤—ã–∑–æ–≤–∞ –≤–æ–ª–æ–Ω—Ç–µ—Ä–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.'
                }
            ];

            return `
                <div class="screen active bg-light">
                    <div class="header">
                        <div class="header-top">
                            <button class="back-btn" onclick="navigateTo('settings')">‚Üê</button>
                            <h1 class="header-title">–ü–æ–º–æ—â—å</h1>
                        </div>
                    </div>
                    
                    <div class="content">
                        <h3 class="section-title">–ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã</h3>
                        
                        ${faqItems.map(item => `
                            <div class="card mb-3">
                                <h4 style="font-weight: 600; color: #2C2D5F; margin-bottom: 8px;">‚ùì ${item.question}</h4>
                                <p style="color: #666; font-size: 14px; line-height: 1.6;">${item.answer}</p>
                            </div>
                        `).join('')}

                        <h3 class="section-title" style="margin-top: 32px;">–°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏</h3>
                        
                        <div class="function-list">
                            <div class="function-item" onclick="window.location.href='tel:+996555000000'">
                                <div class="function-icon">üìû</div>
                                <div style="flex: 1;">
                                    <p style="font-weight: 600; color: #2C2D5F;">–¢–µ–ª–µ—Ñ–æ–Ω</p>
                                    <p style="color: #666; font-size: 12px;">+996 555 000 000</p>
                                </div>
                                <span>‚Ä∫</span>
                            </div>
                            
                            <div class="function-item" onclick="window.location.href='mailto:support@tayan.kg'">
                                <div class="function-icon">üìß</div>
                                <div style="flex: 1;">
                                    <p style="font-weight: 600; color: #2C2D5F;">Email</p>
                                    <p style="color: #666; font-size: 12px;">support@tayan.kg</p>
                                </div>
                                <span>‚Ä∫</span>
                            </div>
                            
                            <div class="function-item">
                                <div class="function-icon">üåê</div>
                                <div style="flex: 1;">
                                    <p style="font-weight: 600; color: #2C2D5F;">–í–µ–±-—Å–∞–π—Ç</p>
                                    <p style="color: #666; font-size: 12px;">www.tayan.kg</p>
                                </div>
                                <span>‚Ä∫</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        function renderMyRequests() {
            return `
                <div class="screen active bg-light">
                <div class="header">
                    <div class="header-top">
                    <button class="back-btn" onclick="navigateTo('home')">‚Üê</button>
                    <h1 class="header-title">–ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è</h1>
                    </div>
                </div>

                <div class="content">
                    <div id="myRequestsList" class="function-list"></div>
                </div>
                </div>
            `;
        }
        function renderRequestDetail() {
            return `
                <div class="screen active bg-light">
                <div class="header">
                    <div class="header-top">
                    <button class="back-btn" onclick="navigateTo('myRequests')">‚Üê</button>
                    <h1 class="header-title">–î–µ—Ç–∞–ª–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è</h1>
                    </div>
                </div>

                <div class="content">
                    <div id="requestDetailBox" class="card">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
                </div>
            `;
        }



        function renderCategories() {
            const categories = Object.keys(categoriesData).map(key => ({
                id: key,
                ...categoriesData[key]
            }));

            return `
                <div class="screen active bg-light">
                    <div class="header">
                        <div class="header-top">
                            <button class="back-btn" onclick="navigateTo('home')">‚Üê</button>
                            <h1 class="header-title">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–º–æ—â–∏</h1>
                        </div>
                    </div>
                    
                    <div class="content">
                        <div class="card-grid">
                            ${categories.map(cat => `
                                <div class="category-card" onclick="selectCategory('${cat.id}')" style="background: linear-gradient(135deg, ${cat.color}, ${cat.color}88);">
                                    <div class="category-icon" style="background: rgba(0,0,0,0.1);">${cat.icon}</div>
                                    <span style="text-align: center; font-weight: 600; color: #2C2D5F; white-space: pre-line;">${cat.title}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        
        function renderCategoryDetail() {
            const category = categoriesData[appState.selectedCategory];
            if (!category) return '';

            return `
                <div class="screen active">
                    <div class="header">
                        <div class="header-top">
                            <button class="back-btn" onclick="navigateTo('categories')">‚Üê</button>
                            <h1 class="header-title">${category.title}</h1>
                        </div>
                    </div>
                    
                    <div class="content">
                        <div class="alert-box danger">
                            ‚ö†Ô∏è <strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –ü—Ä–∏ —Å–µ—Ä—å–µ–∑–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –≤—ã–∑—ã–≤–∞–π—Ç–µ —Å–∫–æ—Ä—É—é –ø–æ–º–æ—â—å (103 –∏–ª–∏ 112)!
                        </div>
                        
                        <h3 class="section-title">–ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</h3>
                        
                        <div class="step-list">
                            ${category.steps.map((step, index) => `
                                <div class="step-item">
                                    <div class="step-number">${index + 1}</div>
                                    <p style="flex: 1; color: #2C2D5F; font-size: 14px;">${step}</p>
                                </div>
                            `).join('')}
                        </div>
                        
                        <button class="btn btn-danger" style="width: 100%; margin-top: 24px;" onclick="window.location.href='tel:103'">
                            üìû –í—ã–∑–≤–∞—Ç—å —Å–∫–æ—Ä—É—é –ø–æ–º–æ—â—å (103)
                        </button>
                        
                        <button class="btn btn-primary" style="width: 100%; margin-top: 12px;" onclick="navigateTo('volunteer-map')">
                            üöë –í—ã–∑–≤–∞—Ç—å –≤–æ–ª–æ–Ω—Ç–µ—Ä–∞
                        </button>
                    </div>
                </div>
            `;
        }

        
        function renderVideo() {
            return `
                <div class="screen active bg-light">
                    <div class="header">
                        <div class="header-top">
                            <button class="back-btn" onclick="navigateTo('home')">‚Üê</button>
                            <h1 class="header-title">–í–∏–¥–µ–æ-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</h1>
                        </div>
                    </div>
                    
                    <div class="content">
                        <div class="video-grid">
                            ${videosData.map((v, index) => `
                                <div class="video-card" onclick="selectVideo(${v.id})">
                                    <div class="video-thumbnail" style="background: linear-gradient(135deg, ${v.color} 0%, ${v.color}88 100%); display: flex; align-items: center; justify-content: center;">
                                        <div style="width: 48px; height: 48px; border-radius: 50%; background: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: center; font-size: 20px;">‚ñ∂</div>
                                        <div style="position: absolute; bottom: 12px; left: 12px; background: rgba(0,0,0,0.6); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${v.duration}</div>
                                    </div>
                                    <div style="padding: 12px;">
                                        <p style="font-weight: 600; color: #2C2D5F; font-size: 14px;">${v.title}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        
        function renderVideoDetail() {
            const video = videosData.find(v => v.id === appState.selectedVideoId);
            if (!video) return '';

            return `
                <div class="screen active">
                    <div class="header">
                        <div class="header-top">
                            <button class="back-btn" onclick="navigateTo('video')">‚Üê</button>
                            <h1 class="header-title">–í–∏–¥–µ–æ</h1>
                        </div>
                    </div>
                    
                    <div style="background: ${video.color}; height: 300px; display: flex; align-items: center; justify-content: center;">
                        <div style="width: 80px; height: 80px; border-radius: 50%; background: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: center; font-size: 32px; cursor: pointer;">‚ñ∂</div>
                    </div>
                    
                    <div class="content">
                        <h2 style="font-family: 'Inter'; font-size: 22px; color: #2C2D5F; margin-bottom: 16px;">${video.title}</h2>
                        
                        <div style="display: flex; gap: 16px; margin-bottom: 24px;">
                            <span style="background: #F5F5F8; padding: 8px 16px; border-radius: 20px; font-size: 14px; color: #666;">
                                ‚è±Ô∏è ${video.duration}
                            </span>
                            <span style="background: #F5F5F8; padding: 8px 16px; border-radius: 20px; font-size: 14px; color: #666;">
                                üëÅÔ∏è 2.5K –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
                            </span>
                        </div>
                        
                        <div class="alert-box info">
                            üì∫ <strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –≠—Ç–æ –¥–µ–º–æ-–≤–µ—Ä—Å–∏—è. –í –ø–æ–ª–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∑–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –ø–æ –æ–∫–∞–∑–∞–Ω–∏—é –ø–µ—Ä–≤–æ–π –ø–æ–º–æ—â–∏.
                        </div>
                        
                        <h3 class="section-title">–û–ø–∏—Å–∞–Ω–∏–µ</h3>
                        <p style="color: #666; line-height: 1.6; margin-bottom: 24px;">
                            –í —ç—Ç–æ–º –≤–∏–¥–µ–æ –≤—ã —É–∑–Ω–∞–µ—Ç–µ –ø–æ–¥—Ä–æ–±–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –æ–∫–∞–∑–∞–Ω–∏—é –ø–µ—Ä–≤–æ–π –ø–æ–º–æ—â–∏. 
                            –í–∏–¥–µ–æ —Å–æ–∑–¥–∞–Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏ –º–µ–¥–∏–∫–∞–º–∏ –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ—à–∞–≥–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è.
                        </p>
                        
                        <button class="btn btn-primary" style="width: 100%;" onclick="alert('–í–∏–¥–µ–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è...')">
                            ‚ñ∂ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –≤–∏–¥–µ–æ
                        </button>
                    </div>
                </div>
            `;
        }

        
        function renderMap() {
            return `
                <div class="screen active">
                    <div class="header">
                        <div class="header-top">
                            <button class="back-btn" onclick="navigateTo('home')">‚Üê</button>
                            <h1 class="header-title">–ö–∞—Ä—Ç–∞ –±–æ–ª—å–Ω–∏—Ü</h1>
                        </div>
                        <div id="hmStatus" style="margin-top:8px;"></div>
                    </div>

                    <div style="height:360px;">
                        <div id="hmLeaflet" style="width:100%; height:100%;"></div>
                    </div>

                    <div class="content bg-light">
                        <h3 class="section-title">–ë–ª–∏–∂–∞–π—à–∏–µ</h3>
                        <div id="hmList" class="function-list"></div>
                    </div>
                </div>
            `;
        }


        
        function renderVolunteerMap() {
            return `
                <div class="screen active">
                <div class="header">
                    <div class="header-top">
                    <button class="back-btn" onclick="navigateTo('home')">‚Üê</button>
                    <h1 class="header-title">–ö–∞—Ä—Ç–∞ –∑–∞—è–≤–∫–∏</h1>
                    </div>
                    <div id="vmStatus" style="margin-top:8px;"></div>
                    <div id="vmEta" style="margin-top:8px;"></div>
                </div>

                <div style="height:360px;">
                    <div id="vmLeaflet" style="width:100%; height:100%;"></div>
                </div>

                <div class="content">
                    <div id="vmBox" class="card">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–∫–∏‚Ä¶</div>
                    <div id="vmActions" style="margin-top:12px;"></div>
                </div>
                </div>
            `;
        }








        
        function renderChat() {
            return `
                <div class="screen active">
                    <div class="header">
                        <div class="header-top">
                            <button class="back-btn" onclick="navigateTo('home')">‚Üê</button>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">ü§ñ</div>
                                <div>
                                    <h1 class="header-title" style="font-size: 18px; margin: 0;">AI-–ø–æ–º–æ—â–Ω–∏–∫</h1>
                                    <p style="color: rgba(255,255,255,0.7); font-size: 12px;">–û–Ω–ª–∞–π–Ω</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; flex: 1; min-height: 0;">
                        <div class="chat-messages" id="chatMessages">
                            ${appState.chatMessages.map(msg => `
                                <div class="chat-message ${msg.type}">${msg.text}</div>
                            `).join('')}
                        </div>
                        
                        <div style="padding: 16px; background: white; border-top: 1px solid #e5e5e5;">
                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="chatInput" class="input-field" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å..." style="flex: 1; margin: 0;">
                                <button class="btn btn-primary" style="padding: 12px 24px;" onclick="sendChatMessage()">üì§</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        
        function renderReviews() {
            return `
                <div class="screen active bg-light">
                    <div class="header">
                        <div class="header-top" style="margin-bottom: 16px;">
                            <button class="back-btn" onclick="navigateTo('home')">‚Üê</button>
                            <h1 class="header-title">–û—Ç–∑—ã–≤—ã</h1>
                        </div>

                        <div id="reviewsStatsBox" class="card"
                            style="background: rgba(255,255,255,0.1); border: none;">
                            <p style="color: rgba(255,255,255,0.7);">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏‚Ä¶</p>
                        </div>
                    </div>

                    <div class="content">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                            <h3 class="section-title" style="margin:0;">–û—Ç–∑—ã–≤—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                            <span style="color:#999;font-size:13px;">
                                –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ –º–æ–∂–Ω–æ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–π –∑–∞—è–≤–∫–∏
                            </span>
                        </div>

                        <div id="latestReviewsList" class="function-list"></div>
                    </div>
                </div>
            `;
        }


        
        function renderSymptomForm() {
            return `
                <div class="screen active">
                <div class="header">
                    <div class="header-top">
                    <button class="back-btn" onclick="navigateTo('home')">‚Üê</button>
                    <h1 class="header-title">–û–ø–∏—Å–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è</h1>
                    </div>
                </div>

                <div class="content">
                    <div id="symptomBox">
                    <div class="input-group">
                        <label class="input-label">–û–ø–∏—à–∏—Ç–µ —Å–∏–º–ø—Ç–æ–º—ã</label>
                        <textarea id="symptoms" class="textarea-field" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –±–æ–ª—å –≤ –≥—Ä—É–¥–∏, –≥–æ–ª–æ–≤–æ–∫—Ä—É–∂–µ–Ω–∏–µ..." required></textarea>
                    </div>

                    <div class="input-group">
                        <label class="input-label">–ê–¥—Ä–µ—Å (–≥–¥–µ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å)</label>
                        <input id="address" class="input-field" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ë–∏—à–∫–µ–∫, –ß—É–π 148, –ø–æ–¥—ä–µ–∑–¥ 2">
                    </div>

                    <div class="input-group">
                        <label class="input-label">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</label>
                        <textarea id="comments" class="textarea-field" placeholder="–õ—é–±–∞—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea>
                    </div>

                    <div class="alert-box info">
                        üí° <strong>–°–æ–≤–µ—Ç:</strong> –ë—É–¥—å—Ç–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–æ—á–Ω—ã –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ —Å–∏–º–ø—Ç–æ–º–æ–≤.
                        –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –≤–æ–ª–æ–Ω—Ç–µ—Ä–∞–º –æ–∫–∞–∑–∞—Ç—å –≤–∞–º –Ω–∞–∏–ª—É—á—à—É—é –ø–æ–º–æ—â—å.
                    </div>

                    <button type="button" id="btnSendRequest" class="btn btn-danger" style="width: 100%;">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
                    </div>
                </div>
                </div>
            `;
        }

        async function loadVolunteerMap() {
            let id = Number(appState.selectedRequestId || loadSelectedRequestId() || 0);

            if (!id) {
                const st = document.getElementById("vmStatus");
                const box = document.getElementById("vmBox");

                if (st) st.innerHTML = `<p style="color:white;font-weight:700;margin:0;">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–∫–∏‚Ä¶</p>`;
                if (box) box.innerHTML = `<div class="alert-box info">‚è≥ –ò—â–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∑–∞—è–≤–∫—É‚Ä¶</div>`;

                try {
                const a = (appState.userRole === "volunteer")
                    ? await api("/volunteer/active", "GET", null, true)
                    : await api("/requests/active", "GET", null, true);

                if (a && a.id) {
                    setSelectedRequestId(a.id);
                    appState.selectedRequestId = a.id;
                }
                } catch (e) {}

                return;
            }

            let r = await api(`/requests/${id}/track`, "GET", null, true);

            const viewerIsVolunteer = appState.userRole === "volunteer";
            if (viewerIsVolunteer) {
                try {
                const vr = await api(`/volunteer/requests/${id}`, "GET", null, true);
                r = { ...r, ...vr };
                } catch (e) {}
            }



            const st = document.getElementById("vmStatus");
            const box = document.getElementById("vmBox");

            
            const userLat = r.lat;
            const userLng = r.lng;
            const volLat = r.volunteer_lat;
            const volLng = r.volunteer_lng;

            if (userLat == null || userLng == null) {
                if (st) st.innerHTML = `<p style="color:white;font-weight:700;margin:0;">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</p>`;
                if (box) box.innerHTML = `<div class="alert-box danger">–ó–∞—è–≤–∫–∞ –±–µ–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç ‚Äî –∫–∞—Ä—Ç—É –ø–æ–∫–∞–∑–∞—Ç—å –Ω–µ–ª—å–∑—è.</div>`;
                return;
            }

            vmInitMap(userLat, userLng);

            
            vmSetUser(userLat, userLng, viewerIsVolunteer ? "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" : "–í—ã");
            if (volLat != null && volLng != null) {
                vmSetVolunteer(volLat, volLng, viewerIsVolunteer ? "–í—ã" : (r.volunteer_name || "–í–æ–ª–æ–Ω—Ç—ë—Ä"));
            }

            vmFitOnce(userLat, userLng, volLat, volLng);

            if (volLat != null && volLng != null && (r.status === "accepted" || r.status === "in_progress")) {
                vmDrawRoute(userLat, userLng, volLat, volLng);
            } else {
                const etaEl = document.getElementById("vmEta");
                if (etaEl) etaEl.innerHTML = ``;
            }


            const contactName = viewerIsVolunteer ? (r.user_name || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å") : (r.volunteer_name || "–í–æ–ª–æ–Ω—Ç—ë—Ä");
            const contactPhone = viewerIsVolunteer ? r.user_phone : r.volunteer_phone;


            if (st) {
                st.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
                        <div>
                            <p style="margin:0;color:rgba(255,255,255,.7);font-size:12px;">
                                ${r.kind === "sos" ? "üö® SOS" : "ü©π –°–∏–º–ø—Ç–æ–º—ã"} ‚Ä¢ –∑–∞—è–≤–∫–∞ #${r.id}
                            </p>
                            <p style="margin:0;color:white;font-weight:800;font-size:16px;">
                                –°—Ç–∞—Ç—É—Å: ${r.status}
                            </p>
                        </div>
                        <div style="text-align:right;">
                            <p style="margin:0;color:rgba(255,255,255,.7);font-size:12px;">–°–æ–∑–¥–∞–Ω–æ</p>
                            <p style="margin:0;color:white;font-weight:700;font-size:12px;">${fmtLocal(r.created_at)}</p>
                        </div>
                    </div>
                `;
            }

            
            const routeBtn = `
                <button class="btn btn-primary" style="width:100%; margin-top:10px;"
                    onclick="vmOpenRoute(${userLat}, ${userLng}, ${volLat ?? "null"}, ${volLng ?? "null"}, ${JSON.stringify(r.address || "")})">
                    üó∫Ô∏è –û—Ç–∫—Ä—ã—Ç—å –º–∞—Ä—à—Ä—É—Ç
                </button>
            `;


            const contactCard = contactPhone ? `
                <div class="alert-box info" style="margin-top:12px;">
                    <strong>${viewerIsVolunteer ? "–ö–æ–Ω—Ç–∞–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" : "–ö–æ–Ω—Ç–∞–∫—Ç –≤–æ–ª–æ–Ω—Ç—ë—Ä–∞"}</strong><br>
                    ${contactName ? `üë§ ${contactName}<br>` : ``}
                    üìû ${contactPhone}<br>
                    <button class="btn btn-primary" style="width:100%; margin-top:10px;"
                        onclick="window.location.href='tel:${contactPhone}'">
                        üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å
                    </button>
                </div>
            ` : `
                <div class="alert-box info" style="margin-top:12px;">
                    <strong>${viewerIsVolunteer ? "–ö–æ–Ω—Ç–∞–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" : "–ö–æ–Ω—Ç–∞–∫—Ç –≤–æ–ª–æ–Ω—Ç—ë—Ä–∞"}</strong><br>
                    <span style="color:#666;">–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω</span>
                </div>
            `;


            const locationCard = (r.address || (userLat != null && userLng != null)) ? `
                <div class="card" style="margin-top:12px;">
                    <p style="font-weight:700;color:#2C2D5F;margin-bottom:8px;">üìç –ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</p>
                    ${r.address ? `<p style="color:#555;font-size:14px;margin-bottom:6px;"><strong>–ê–¥—Ä–µ—Å:</strong> ${r.address}</p>` : ``}
                    ${(userLat != null && userLng != null) ? `
                        <p style="color:#555;font-size:14px;"><strong>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</strong> ${Number(userLat).toFixed(6)}, ${Number(userLng).toFixed(6)}</p>
                    ` : ``}
                </div>
            ` : ``;


            const detailsCard = (r.symptoms || r.comments) ? `
                <div class="vm-card">
                    <h4>ü©π –î–µ—Ç–∞–ª–∏</h4>
                    ${r.symptoms ? `<div class="vm-muted"><strong>–°–∏–º–ø—Ç–æ–º—ã:</strong>\n${r.symptoms}</div>` : ""}
                    ${r.comments ? `<div class="vm-muted" style="margin-top:8px;"><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong>\n${r.comments}</div>` : ""}
                </div>
             ` : "";


            const timeline = `
                <div class="card" style="margin-top:12px;">
                    <p style="font-weight:700;color:#2C2D5F;margin-bottom:8px;">–¢–∞–π–º–ª–∞–π–Ω</p>
                    <p style="color:#666;font-size:13px;">–°–æ–∑–¥–∞–Ω–æ: ${fmtTime(r.created_at)}</p>
                    ${r.accepted_at ? `<p style="color:#666;font-size:13px;">–ü—Ä–∏–Ω—è—Ç–æ: ${fmtTime(r.accepted_at)}</p>` : ``}
                    ${r.in_progress_at ? `<p style="color:#666;font-size:13px;">–í –ø—É—Ç–∏: ${fmtTime(r.in_progress_at)}</p>` : ``}
                    ${r.completed_at ? `<p style="color:#666;font-size:13px;">–ó–∞–≤–µ—Ä—à–µ–Ω–æ: ${fmtTime(r.completed_at)}</p>` : ``}
                    ${r.canceled_at ? `<p style="color:#666;font-size:13px;">–û—Ç–º–µ–Ω–µ–Ω–æ: ${fmtTime(r.canceled_at)}</p>` : ``}
                </div>
            `;

            
            const volActions = (viewerIsVolunteer && !(r.status === "completed" || r.status === "canceled")) ? `
                <div style="display:flex; gap:8px; margin-top:16px;">
                    <button type="button" class="btn btn-outline" style="flex:1;" onclick="volSetStatus('in_progress', true)">–í –ø—É—Ç–∏</button>
                    <button type="button" class="btn btn-outline" style="flex:1; border-color:#B91717; color:#B91717;" onclick="volSetStatus('canceled', true)">–û—Ç–º–µ–Ω–∏—Ç—å</button>
                    <button type="button" class="btn btn-primary" style="flex:1;" onclick="volSetStatus('completed', true)">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
                </div>
            ` : ``;


            if (box) {
                box.innerHTML = `
                    ${contactCard}
                    ${routeBtn}
                    ${locationCard}
                    ${detailsCard}
                    ${timeline}
                    ${volActions}
                `;
            }
        }


        /*async function loadVolunteerMy() {
            const items = await api("/volunteer/my", "GET", null, true);
            const box = document.getElementById("myAcceptedList");
            if (!box) return;

            if (!items.length) {
                box.innerHTML = `<div class="card">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–∏–Ω—è—Ç—ã—Ö –∑–∞—è–≤–æ–∫.</div>`;
                return;
            }

            box.innerHTML = items.map(x => {
                const created = new Date(x.created_at).getTime();
                const accepted = x.accepted_at ? new Date(x.accepted_at).getTime() : null;

                const reactionText = accepted ? fmtMinutes(accepted - created) : "‚Äî";

                const statusText =
                    x.status === "accepted" ? "–ü—Ä–∏–Ω—è—Ç–∞"
                    : x.status === "in_progress" ? "–í –ø—É—Ç–∏ / –≤ —Ä–∞–±–æ—Ç–µ"
                    : x.status === "completed" ? "–ó–∞–≤–µ—Ä—à–µ–Ω–∞"
                    : x.status === "canceled" ? "–û—Ç–º–µ–Ω–µ–Ω–∞"
                    : x.status;

                const bg =
                    x.status === "completed" ? "background:#E8F5E9;border:1px solid #A5D6A7;"
                    : x.status === "canceled" ? "background:#FFEBEE;border:1px solid #EF9A9A;"
                    : x.status === "in_progress" ? "background:#E3F2FD;border:1px solid #90CAF9;"
                    : "";

                return `
                    <div class="function-item" style="${bg}" onclick="openVolunteerRequest(${x.id})">
                        <div class="function-icon">${x.kind === "sos" ? "üö®" : "ü©π"}</div>
                        <div style="flex:1;">
                            <p style="font-weight:600;color:#2C2D5F;">
                                ${x.kind === "sos" ? "SOS" : "–°–∏–º–ø—Ç–æ–º—ã"} ‚Ä¢ ${statusText}
                            </p>

                            <p style="color:#666;font-size:12px;">
                                –°–æ–∑–¥–∞–Ω–æ: ${new Date(x.created_at).toLocaleString()}
                            </p>

                            <p style="color:#666;font-size:12px;">
                                –†–µ–∞–∫—Ü–∏—è: <strong>${reactionText}</strong>
                            </p>

                            ${x.accepted_at ? `<p style="color:#666;font-size:12px;">–ü—Ä–∏–Ω—è—Ç–æ: ${fmtTime(x.accepted_at)}</p>` : ``}
                            ${x.in_progress_at ? `<p style="color:#666;font-size:12px;">–í –ø—É—Ç–∏: ${fmtTime(x.in_progress_at)}</p>` : ``}
                            ${x.completed_at ? `<p style="color:#666;font-size:12px;">–ó–∞–≤–µ—Ä—à–µ–Ω–æ: ${fmtTime(x.completed_at)}</p>` : ``}
                            ${x.canceled_at ? `<p style="color:#666;font-size:12px;">–û—Ç–º–µ–Ω–µ–Ω–æ: ${fmtTime(x.canceled_at)}</p>` : ``}
                        </div>
                        <span>‚Ä∫</span>
                    </div>
                `;
            }).join("");
        }*/

        async function loadMyRequests() {
            const items = await api("/requests/my", "GET", null, true);
            const box = document.getElementById("myRequestsList");
            if (!box) return;

            if (!items.length) {
                box.innerHTML = `<div class="card">–ü–æ–∫–∞ –Ω–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π.</div>`;
                return;
            }

            box.innerHTML = items.map(x => {
                const bg =
                    x.status === "completed"
                    ? "background:#E8F5E9;border:1px solid #A5D6A7;"
                    : x.status === "canceled"
                    ? "background:#FFEBEE;border:1px solid #EF9A9A;"
                    : "";

                const statusText =
                    x.status === "new" ? "–ù–æ–≤–∞—è"
                    : x.status === "accepted" ? "–ü—Ä–∏–Ω—è—Ç–∞"
                    : x.status === "in_progress" ? "–í —Ä–∞–±–æ—Ç–µ"
                    : x.status === "completed" ? "–ó–∞–≤–µ—Ä—à–µ–Ω–æ"
                    : x.status === "canceled" ? "–û—Ç–º–µ–Ω–µ–Ω–æ"
                    : x.status;

                return `
                    <div class="function-item" style="${bg}" onclick="openRequest(${x.id})">
                    <div class="function-icon">
                        ${x.status === "completed" ? "‚úÖ" : x.status === "canceled" ? "‚ùå" : x.kind === "sos" ? "üö®" : "ü©π"}
                    </div>
                    <div style="flex:1;">
                        <p style="font-weight:600;color:#2C2D5F;">
                        ${x.kind === "sos" ? "SOS" : "–°–∏–º–ø—Ç–æ–º—ã"} ‚Ä¢ ${statusText}
                        </p>
                        <p style="color:#666;font-size:12px;">
                        ${fmtLocal(x.created_at)}
                        </p>
                    </div>
                    <span>‚Ä∫</span>
                    </div>
                `;
                }).join("");

        }

        async function loadLatestReviews() {
            const items = await api("/reviews/latest?limit=30", "GET", null, false);
            const box = document.getElementById("latestReviewsList");
            if (!box) return;

            if (!items.length) {
                box.innerHTML = `<div class="card">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤.</div>`;
                return;
            }

            box.innerHTML = items.map(x => `
                <div class="review-card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
                        <div style="display:flex; gap:12px;">
                            <div style="width:48px;height:48px;border-radius:50%;background:rgba(44,45,95,0.1);display:flex;align-items:center;justify-content:center;">üë§</div>
                            <div>
                                <p style="font-weight:600; color:#2C2D5F;">${x.user_name || ("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #" + x.user_id)}</p>
                                <p style="color:#999; font-size:12px;">${fmtLocal(x.reviewed_at)}</p>
                            </div>
                        </div>
                        <span>${"‚≠ê".repeat(x.rating)}</span>
                    </div>

                    ${x.review_text ? `<p style="color:#555;font-size:14px;margin-bottom:12px;line-height:1.5;">${x.review_text}</p>` : ``}

                    <div style="background:#F5F5F8;border:1px solid #e5e5e5;border-radius:12px;padding:12px;display:flex;justify-content:space-between;gap:10px;align-items:center;">
                        <div>
                            <p style="color:#999; font-size:12px;">–í–æ–ª–æ–Ω—Ç—ë—Ä</p>
                            <p style="color:#2C2D5F; font-weight:700; font-size:14px;">${x.volunteer_name || ("ID " + x.volunteer_id)}</p>
                        </div>
                        <button class="btn btn-primary" style="padding:10px 14px;" onclick="openVolunteerProfile(${x.volunteer_id}, '${x.volunteer_name || "–í–æ–ª–æ–Ω—Ç—ë—Ä"}')">
                            –ü—Ä–æ—Ñ–∏–ª—å
                        </button>
                    </div>
                </div>
            `).join("");
        }



        async function syncActiveRequestForHome() {
            try {
                if (appState.userRole === "volunteer") {
                const a = await api("/volunteer/active", "GET", null, true);
                if (a && a.id) {
                    setSelectedRequestId(a.id);
                    appState.hasActiveRequest = true;
                    appState.activeRequestStatus = a.status || "accepted";
                } else {
                    clearSelectedRequestId();
                    appState.hasActiveRequest = false;
                    appState.activeRequestStatus = "";
                }
                return;
                }

                const a = await api("/requests/active", "GET", null, true);
                if (a && a.id) {
                setSelectedRequestId(a.id);
                appState.hasActiveRequest = true;
                appState.activeRequestStatus = a.status || "new";
                } else {
                clearSelectedRequestId();
                appState.hasActiveRequest = false;
                appState.activeRequestStatus = "";
                }
            } catch (e) {
                clearSelectedRequestId();
                appState.hasActiveRequest = false;
                appState.activeRequestStatus = "";
            }
        }


        function openVolunteerProfile(volunteerId, name = "–í–æ–ª–æ–Ω—Ç—ë—Ä") {
            appState.selectedVolunteerId = volunteerId;
            appState.selectedVolunteerName = name;
            navigateTo("volunteer-profile");
        }

        /*async function loadVolunteerMap() {
            const id = appState.selectedRequestId;
            if (!id) throw new Error("–ù–µ—Ç id –∑–∞—è–≤–∫–∏");

            const r = await api(`/requests/${id}/track`, "GET", null, true);

            console.log("REQUEST:", r);


            const st = document.getElementById("vmStatus");
            const isVolunteer = appState.userRole === "volunteer";

            let text = "‚è≥ –ò—â–µ–º –≤–æ–ª–æ–Ω—Ç—ë—Ä–∞‚Ä¶";
            if (r.status === "accepted") text = isVolunteer ? "‚úÖ –í—ã –ø—Ä–∏–Ω—è–ª–∏ –∑–∞—è–≤–∫—É" : "‚úÖ –í–æ–ª–æ–Ω—Ç—ë—Ä –ø—Ä–∏–Ω—è–ª –∑–∞—è–≤–∫—É";
            if (r.status === "in_progress") text = isVolunteer ? "üöó –í—ã –≤ –ø—É—Ç–∏" : "üöó –í–æ–ª–æ–Ω—Ç—ë—Ä –≤ –ø—É—Ç–∏";
            if (r.status === "completed") text = "üèÅ –ó–∞—è–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞";
            if (r.status === "canceled") text = "‚ùå –ó–∞—è–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞";


            const box = document.getElementById("vmBox");

            let userLat = r.lat ?? appState.lastRequestLat;
            let userLng = r.lng ?? appState.lastRequestLng;

            if (userLat == null || userLng == null) {
                if (r.address) {
                    try {
                        const g = await geocodeAddress(r.address);
                        if (g) {
                            userLat = g.lat;
                            userLng = g.lng;
                        }
                    } catch (e) {}
                }
            }

            if (userLat == null || userLng == null) {
                if (box) box.innerHTML = `üìç –ù–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç. –£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å: <strong>${r.address || "‚Äî"}</strong>`;
                vmInitMap(42.8746, 74.5698);
                vmSetUser(42.8746, 74.5698, "–ë–∏—à–∫–µ–∫ (–ø—Ä–∏–º–µ—Ä)");
                return;
            }

            vmInitMap(userLat, userLng);
            vmSetUser(userLat, userLng, "–í—ã –∑–¥–µ—Å—å");

            const volLat = r.volunteer_lat ?? null;
            const volLng = r.volunteer_lng ?? null;

            if (volLat != null && volLng != null) {
                vmSetVolunteer(volLat, volLng, r.volunteer_name || "–í–æ–ª–æ–Ω—Ç—ë—Ä");
            } else {
                if (vmVolMarker && vmMap) {
                    vmMap.removeLayer(vmVolMarker);
                    vmVolMarker = null;
                }
            }

            vmFitOnce(userLat, userLng, volLat, volLng);
            vmDrawRoute(userLat, userLng, volLat, volLng);


            if (box) {
                const row = (icon, title, value) => `
                    <div style="background:#F6F7FB;padding:10px 12px;border-radius:12px;">
                    <div style="display:flex;gap:10px;align-items:flex-start;">
                        <div style="width:22px;flex:0 0 22px;opacity:.9;">${icon}</div>
                        <div style="flex:1;">
                        <div style="font-weight:700;color:#2C2D5F;margin-bottom:2px;">${title}</div>
                        <div style="color:#444;line-height:1.35;white-space:pre-line;">${value}</div>
                        </div>
                    </div>
                    </div>
                `;

                box.innerHTML = `

                    
                    <div style="display:flex;flex-direction:column;gap:10px;">

                    ${row("üìå", "–°—Ç–∞—Ç—É—Å", r.status)}

                    ${r.address ? row("üìç", "–ê–¥—Ä–µ—Å", r.address) : ""}

                    ${r.symptoms ? row("ü©π", "–°–∏–º–ø—Ç–æ–º—ã", r.symptoms) : ""}

                    ${r.comments ? row("üí¨", "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π", r.comments) : ""}

                    ${(r.volunteer_name || r.volunteer_phone) ? `
                        <div style="background:#F6F7FB;padding:10px 12px;border-radius:12px;">
                        <div style="font-weight:700;color:#2C2D5F;margin-bottom:8px;">üßë‚Äç‚öïÔ∏è –í–æ–ª–æ–Ω—Ç—ë—Ä</div>

                        ${r.volunteer_name ? `
                            <div style="display:flex;gap:10px;align-items:center;color:#444;margin-bottom:6px;">
                                <div style="width:22px;">üë§</div>
                                <div><strong>${r.volunteer_name}</strong></div>
                            </div>
                        ` : ""}

                        ${r.volunteer_phone ? `
                            <div style="display:flex;gap:10px;align-items:center;color:#444;">
                                <div style="width:22px;">üìû</div>
                                <div>${r.volunteer_phone}</div>
                            </div>

                            <button class="btn btn-primary"
                                style="width:100%; margin-top:10px;"
                                onclick="callPhone('${String(r.volunteer_phone).replace(/'/g,"\\'")}')">
                                üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å –≤–æ–ª–æ–Ω—Ç—ë—Ä—É
                            </button>
                        ` : ""}
                        </div>

                        ${(r.user_name || r.user_phone) ? `
                            <div style="background:#F6F7FB;padding:10px 12px;border-radius:12px;">
                                <div style="font-weight:700;color:#2C2D5F;margin-bottom:8px;">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>

                                ${r.user_name ? `
                                <div style="display:flex;gap:10px;align-items:center;color:#444;margin-bottom:6px;">
                                    <div style="width:22px;">üë§</div>
                                    <div><strong>${r.user_name}</strong></div>
                                </div>
                                ` : ""}

                                ${r.user_phone ? `
                                <div style="display:flex;gap:10px;align-items:center;color:#444;">
                                    <div style="width:22px;">üìû</div>
                                    <div>${r.user_phone}</div>
                                </div>

                                <button class="btn btn-primary"
                                    style="width:100%; margin-top:10px;"
                                    onclick="callPhone('${String(r.user_phone).replace(/'/g,"\\'")}')">
                                    üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                                </button>
                                ` : ""}
                            </div>
                         ` : ""}

                    ` : ""}

                    </div>
                `;
                }

                const actions = document.getElementById("vmActions");
                if (actions) {
                    actions.innerHTML = `
                        <button class="btn btn-outline" style="width:100%; margin-bottom:10px;" onclick="vmFocusAll()">
                            üìå –ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ
                        </button>

                        <button class="btn btn-primary" style="width:100%;" onclick="vmDrawRoute(${userLat},${userLng},${volLat ?? "null"},${volLng ?? "null"})">
                            üß≠ –ü–æ–∫–∞–∑–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç –Ω–∞ –∫–∞—Ä—Ç–µ
                        </button>

                    `;
                }

                const etaBox = document.getElementById("vmEta");

                if (etaBox && volLat != null && volLng != null && r.status === "in_progress") {
                const eta = await osrmEta(volLat, volLng, userLat, userLng);
                if (eta) {
                    etaBox.innerHTML = `
                    <div class="alert-box info">
                        üìç ${eta.minutes} –º–∏–Ω ‚Ä¢ ${eta.km} –∫–º
                    </div>
                    `;
                }
            }


        }*/






        async function loadVolunteerProfile() {
            const volunteerId = appState.selectedVolunteerId;

            const rating = await api(`/volunteer/${volunteerId}/rating`, "GET", null, false);
            const reviews = await api(`/volunteer/${volunteerId}/reviews?limit=50&offset=0`, "GET", null, false);

            const rbox = document.getElementById("volunteerHeader");
            const list = document.getElementById("volunteerReviewsList");

            if (rbox) {
                const avg = (rating.avg_rating || 0).toFixed(1);

                rbox.innerHTML = `
                    <div style="display:flex; gap:16px; align-items:center;">
                        <div style="width:64px;height:64px;border-radius:50%;background:rgba(44,45,95,0.1);display:flex;align-items:center;justify-content:center;font-size:28px;">
                            üë§
                        </div>

                        <div style="flex:1;">
                            <h2 style="margin:0;color:#2C2D5F;">
                                ${appState.selectedVolunteerName}
                            </h2>


                            <div style="display:flex;align-items:center;gap:8px;margin-top:4px;">
                                <span style="font-weight:700;font-size:18px;">
                                    ${avg}
                                </span>
                                <span style="font-size:18px;">
                                    ${renderStars(rating.avg_rating)}
                                </span>
                            </div>

                            <p style="color:#666;font-size:13px;margin-top:4px;">
                                ${rating.reviews_count || 0} –æ—Ç–∑—ã–≤–æ–≤
                            </p>
                        </div>
                        <div class="volunteer-badges">
                            <span class="badge blue">–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π</span>
                            <span class="badge green">–ü–µ—Ä–≤–∞—è –ø–æ–º–æ—â—å</span>
                            <span class="badge gray">–ë–∏—à–∫–µ–∫</span>
                        </div>

                        <div class="volunteer-actions">
                            <button class="icon-btn outline">üí¨</button>
                            <button class="icon-btn primary">üîó</button>
                        </div>

                    </div>
                `;
            }


            if (list) {
                if (!reviews.length) {
                    list.innerHTML = `<div class="card">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤ –ø–æ —ç—Ç–æ–º—É –≤–æ–ª–æ–Ω—Ç—ë—Ä—É.</div>`;
                    return;
                }

                list.innerHTML = reviews.map(x => `
                    <div class="review-card">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <div>
                                <p style="font-weight:700; color:#2C2D5F;">${x.user_name || ("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #" + x.user_id)}</p>
                                <p style="color:#999; font-size:12px;">${fmtLocal(x.reviewed_at)}</p>
                            </div>
                            <span>${renderStars(x.rating)}</span>
                        </div>
                        ${x.review_text ? `<p style="color:#555;font-size:14px;line-height:1.5;">${x.review_text}</p>` : `<p style="color:#999;font-size:13px;">(–±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è)</p>`}
                    </div>
                `).join("");
            }
        }



        
        function attachEvents(screen) {
            if (screen === "auth") {
                const btn = document.getElementById("btnRegister");
                if (btn) btn.onclick = async () => {
                    const name = document.getElementById("name").value.trim();
                    const email = document.getElementById("email").value.trim();
                    const phone = document.getElementById("phone").value.trim();
                    const password = document.getElementById("password").value;
                    const role = document.getElementById("role").value;

                    try {
                    const res = await api("/auth/register", "POST", { name, email, phone, password, role }, false);
                    localStorage.setItem("token", res.access_token);

                    const me = await api("/auth/me", "GET", null, true);
                    appState.userName = me.name;
                    appState.userEmail = me.email || "";
                    appState.userPhone = me.phone;
                    appState.userRole = me.role || role;

                    navigateTo("home");
                    } catch (err) {
                    alert("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: " + err.message);
                    }
                };
            }


            
            if (screen === "login") {
                const btn = document.getElementById("btnLogin");
                if (btn) btn.onclick = async () => {
                    const phone = document.getElementById("loginPhone").value.trim();
                    const password = document.getElementById("loginPassword").value;

                    try {
                    const res = await api("/auth/login", "POST", { phone, password }, false);
                    localStorage.setItem("token", res.access_token);

                    const me = await api("/auth/me", "GET", null, true);
                    appState.userName = me.name;
                    appState.userEmail = me.email || "";
                    appState.userPhone = me.phone;
                    appState.userRole = me.role || "user";

                    navigateTo("home");
                    } catch (err) {
                    alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + err.message);
                    }
                };
            }


            if (screen === "home") {
                if (homeRefreshLock) return;
                homeRefreshLock = true;

                (async () => {
                    try {
                    await syncActiveRequestForHome();
                    renderScreen("home");
                    } finally {
                    setTimeout(() => { homeRefreshLock = false; }, 0);
                    }
                })();
            }




            if (screen === 'volunteer-open') {
                startPolling(async () => {
                    try {
                        await loadVolunteerOpen();
                    } catch (e) {
                        stopPolling();
                        alert("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∏–ª–∏ –æ—à–∏–±–∫–∞: " + e.message);
                        navigateTo("home");
                    }
                }, 10000);
            }


            if (screen === 'volunteer-my') {
                startPolling(async () => {
                    try {
                        await loadVolunteerMy();
                    } catch (e) {
                        stopPolling();
                        alert("–û—à–∏–±–∫–∞: " + e.message);
                        navigateTo("home");
                    }
                }, 10000);
            }

            if (screen === 'volunteer-request') {
                (async () => {
                    try {
                        const id = appState.selectedRequestId;
                        const r = await api(`/volunteer/requests/${id}`, "GET", null, true);

                        const box = document.getElementById("volunteerRequestBox");

                        const closed = r.status === "completed" || r.status === "canceled";

                        box.innerHTML = `
                            <h3 style="color:#2C2D5F;margin-bottom:8px;">
                                ${r.kind === "sos" ? "üö® SOS" : "ü©π –°–∏–º–ø—Ç–æ–º—ã"} ‚Ä¢ ${r.status}
                            </h3>

                            <p style="color:#666;font-size:13px;margin-bottom:12px;">
                                ${fmtLocal(r.created_at)}
                            </p>
                            ${r.user_phone ? `
                                <div class="alert-box info" style="margin-top:12px;">
                                    <strong>–ö–æ–Ω—Ç–∞–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</strong><br>
                                    ${r.user_name ? `üë§ ${r.user_name}<br>` : ""}
                                    üìû ${r.user_phone}<br>
                                    <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="window.location.href='tel:${r.user_phone}'">
                                        üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                                    </button>
                                </div>
                            ` : ""}

                            ${(r.lat != null && r.lng != null) ? `
                                <button class="btn btn-primary" style="width:100%; margin-top:10px;"
                                    onclick="window.open('https://www.google.com/maps?q=${r.lat},${r.lng}', '_blank')">
                                    üó∫Ô∏è –û—Ç–∫—Ä—ã—Ç—å –º–∞—Ä—à—Ä—É—Ç (–ø–æ GPS)
                                </button>
                            ` : (r.address ? `
                                <button class="btn btn-primary" style="width:100%; margin-top:10px;"
                                    onclick="window.open('https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(r.address)}', '_blank')">
                                    üó∫Ô∏è –û—Ç–∫—Ä—ã—Ç—å –º–∞—Ä—à—Ä—É—Ç (–ø–æ –∞–¥—Ä–µ—Å—É)
                                </button>
                            ` : `
                                <div class="alert-box info" style="margin-top:12px;">
                                    üìç –ê–¥—Ä–µ—Å/–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã ‚Äî –º–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –Ω–µ–ª—å–∑—è
                                </div>
                            `)}




                            ${r.symptoms ? `<p style="margin-bottom:8px;"><strong>–°–∏–º–ø—Ç–æ–º—ã:</strong><br>${r.symptoms}</p>` : ""}
                            ${r.comments ? `<p style="margin-bottom:12px;"><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong><br>${r.comments}</p>` : ""}
                            <div class="card" style="margin-top:12px;">
                                <p style="font-weight:600;color:#2C2D5F;margin-bottom:8px;">–¢–∞–π–º–ª–∞–π–Ω</p>
                                <p style="color:#666;font-size:13px;">–°–æ–∑–¥–∞–Ω–æ: ${fmtTime(r.created_at)}</p>
                                ${r.accepted_at ? `<p style="color:#666;font-size:13px;">–ü—Ä–∏–Ω—è—Ç–æ: ${fmtTime(r.accepted_at)}</p>` : ``}
                                ${r.in_progress_at ? `<p style="color:#666;font-size:13px;">–í –ø—É—Ç–∏: ${fmtTime(r.in_progress_at)}</p>` : ``}
                                ${r.completed_at ? `<p style="color:#666;font-size:13px;">–ó–∞–≤–µ—Ä—à–µ–Ω–æ: ${fmtTime(r.completed_at)}</p>` : ``}
                                ${r.canceled_at ? `<p style="color:#666;font-size:13px;">–û—Ç–º–µ–Ω–µ–Ω–æ: ${fmtTime(r.canceled_at)}</p>` : ``}
                            </div>
                            ${(r.address || (r.lat != null && r.lng != null)) ? `
                                <div class="card" style="margin-top:12px;">
                                    <p style="font-weight:600;color:#2C2D5F;margin-bottom:8px;">üìç –ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</p>
                                    ${r.address ? `<p style="color:#555;font-size:14px;margin-bottom:6px;"><strong>–ê–¥—Ä–µ—Å:</strong> ${r.address}</p>` : ``}
                                    ${(r.lat != null && r.lng != null) ? `
                                        <p style="color:#555;font-size:14px;"><strong>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</strong> ${r.lat.toFixed(6)}, ${r.lng.toFixed(6)}</p>
                                    ` : ``}
                                </div>
                            ` : ``}



                            ${closed ? `
                                <div class="alert-box info">–ó–∞—è–≤–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞.</div>
                            ` : `
                                <div style="display:flex; gap:8px; margin-top:16px;">
                                    <button type="button" class="btn btn-outline" style="flex:1;" onclick="volSetStatus('in_progress')">–í –ø—É—Ç–∏</button>
                                    <button type="button" class="btn btn-outline" style="flex:1; border-color:#B91717; color:#B91717;" onclick="volSetStatus('canceled')">–û—Ç–º–µ–Ω–∏—Ç—å</button>
                                    <button type="button" class="btn btn-primary" style="flex:1;" onclick="volSetStatus('completed')">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
                                </div>
                            `}
                        `;
                    } catch (e) {
                        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å: " + e.message);
                        navigateTo("volunteer-my");
                    }
                })();
            }

            if (screen === "reviews") {
                startPolling(async () => {
                    try {
                        const stats = await loadReviewsStats();
                        const box = document.getElementById("reviewsStatsBox");

                        if (box) {
                            box.innerHTML = `
                                <div style="display:flex; justify-content:space-between;">
                                    <div>
                                        <p style="color:rgba(255,255,255,0.7);font-size:14px;">
                                            –°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞
                                        </p>
                                        <div style="display:flex; align-items:center; gap:8px;">
                                            <span style="font-size:28px; color:white;">
                                                ${stats.avg_rating.toFixed(1)}
                                            </span>
                                            <span style="font-size:18px;">
                                                ${renderStars(stats.avg_rating)}
                                            </span>
                                        </div>
                                    </div>

                                    <div style="text-align:right;">
                                        <p style="color:rgba(255,255,255,0.7);font-size:14px;">
                                            –í—Å–µ–≥–æ –æ—Ç–∑—ã–≤–æ–≤
                                        </p>
                                        <p style="font-size:28px; color:white;">
                                            ${stats.reviews_count}
                                        </p>
                                    </div>
                                </div>
                            `;
                        }

                        await loadLatestReviews();
                    } catch (e) {
                        stopPolling();
                        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç–∑—ã–≤—ã: " + e.message);
                        navigateTo("home");
                    }
                }, 15000);
            }


            if (screen === "volunteer-profile") {
                (async () => {
                    try {
                        await loadVolunteerProfile();
                    } catch (e) {
                        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å: " + e.message);
                        navigateTo("reviews");
                    }
                })();
            }

            if (screen === "volunteer-map") {
                startPolling(async () => {
                    try {
                    await loadVolunteerMap();
                    } catch (e) {
                    const msg = String(e?.message || e);

                    if (msg.includes("–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∑–∞—è–≤–∫–∏")) {
                        const st = document.getElementById("vmStatus");
                        const box = document.getElementById("vmBox");
                        if (st) st.innerHTML = `<p style="color:white;font-weight:700;margin:0;">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–∫–∏‚Ä¶</p>`;
                        if (box) box.innerHTML = `<div class="alert-box info">‚è≥ –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∫–∞—Ä—Ç—É‚Ä¶</div>`;
                        return;
                    }

                    stopPolling();

                    const box = document.getElementById("vmBox");
                    const st = document.getElementById("vmStatus");
                    if (st) st.innerHTML = `<p style="color:white;font-weight:700;margin:0;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–∫–∏</p>`;
                    if (box) {
                        box.innerHTML = `
                        <div class="alert-box danger">
                            –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞—è–≤–∫—É: ${msg}
                        </div>
                        <button class="btn btn-primary" style="width:100%; margin-top:12px;" onclick="navigateTo('home')">
                            ‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é
                        </button>
                        `;
                    }
                    }

                }, 7000);

                startVolunteerGeo();

            }






            
            if (screen === "symptom-form") {
                const btn = document.getElementById("btnSendRequest");
                if (btn) btn.onclick = async () => {
                    const symptoms = document.getElementById("symptoms").value.trim();
                    const comments = document.getElementById("comments").value.trim();
                    const address = (document.getElementById("address").value || "").trim();

                    appState.selectedRequestId = 0;
                    setSelectedRequestId(0);

                    navigateTo("volunteer-map", "creating request (optimistic)");

                    const st = document.getElementById("vmStatus");
                    const box = document.getElementById("vmBox");

                    if (st) st.innerHTML = `<p style="color:white;font-weight:800;margin:0;">–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞—è–≤–∫—É‚Ä¶</p>`;
                    if (box) box.innerHTML = `
                        <div class="alert-box info">
                            ‚è≥ –°–æ–∑–¥–∞—ë–º –∑–∞—è–≤–∫—É –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é‚Ä¶
                        </div>
                    `;

                    try {
                        const geo = await getGeo();

                        const created = await api("/requests", "POST", {
                            kind: "symptom",
                            symptoms,
                            comments,
                            lat: geo.lat,
                            lng: geo.lng,
                            address
                        }, true);

                        const rid = created?.id || created?.request_id || (created?.request && created.request.id) || 0;

                        setSelectedRequestId(rid);
                        appState.selectedRequestId = rid;

                        await loadVolunteerMap();

                    } catch (err) {
                        const st2 = document.getElementById("vmStatus");
                        const box2 = document.getElementById("vmBox");

                        if (st2) st2.innerHTML = `<p style="color:white;font-weight:800;margin:0;">–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏</p>`;
                        if (box2) box2.innerHTML = `
                            <div class="alert-box danger">
                                –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É: ${err.message}
                            </div>
                            <button class="btn btn-primary" style="width:100%; margin-top:12px;" onclick="navigateTo('symptom-form')">
                                ‚Üê –ù–∞–∑–∞–¥
                            </button>
                        `;
                    }
                };
            }
            if (screen === "map") {
                (async () => {
                    const st = document.getElementById("hmStatus");
                    const listBox = document.getElementById("hmList");

                    if (st) st.innerHTML = `<div class="alert-box info">üìç –ü–æ–ª—É—á–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é‚Ä¶</div>`;

                    const geo = await getGeo();
                    const lat = geo.lat ?? 42.8746;
                    const lng = geo.lng ?? 74.5698;

                    hmInitMap(lat, lng);
                    if (geo.lat != null && geo.lng != null) hmSetUser(lat, lng);

                    if (st) st.innerHTML = `<div class="alert-box info">üîé –ò—â–µ–º –±–ª–∏–∂–∞–π—à–∏–µ –±–æ–ª—å–Ω–∏—Ü—ã‚Ä¶</div>`;

                    try {
                        const items = await fetchNearbyHospitalsOSM(lat, lng, 5000, 30);

                        if (st) st.innerHTML = `<div class="alert-box info">üè• –ù–∞–π–¥–µ–Ω–æ: ${items.length}</div>`;

                        hmSetHospitals(items);
                        hmFitAll(geo.lat, geo.lng, items);
                        hmRenderList(geo.lat, geo.lng, items);

                    } catch (e) {
                        if (st) st.innerHTML = `<div class="alert-box danger">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–æ–ª—å–Ω–∏—Ü</div>`;
                        if (listBox) listBox.innerHTML = `<div class="card">–û—à–∏–±–∫–∞: ${e.message}</div>`;
                    }
                })();
            }



            if (screen === 'chat') {
                const input = document.getElementById('chatInput');
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendChatMessage();
                    }
                });
                
                const chatMessages = document.getElementById('chatMessages');
                if (chatMessages) {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }




            if (screen === 'myRequests') {
                startPolling(async () => {
                    try {
                        await loadMyRequests();
                    } catch (e) {
                        stopPolling();
                        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏—è: " + e.message);
                        navigateTo("home");
                    }
                }, 10000);
            }

            if (screen === 'requestDetail') {
                (async () => {
                    try {
                    const id = appState.selectedRequestId;
                    const r = await api(`/requests/${id}`, "GET", null, true);
                    let vRating = null;
                    if (r.accepted_by) {
                    try {
                        vRating = await api(`/volunteer/${r.accepted_by}/rating`, "GET", null, true);
                    } catch (e) {}
                    }

                    const box = document.getElementById("requestDetailBox");
                    let reaction_minutes = null;
                    if (r.accepted_at) {
                        const created = new Date(r.created_at).getTime();
                        const accepted = new Date(r.accepted_at).getTime();
                        reaction_minutes = Math.max(0, Math.round((accepted - created) / 60000));
                    }
                    box.innerHTML = `
                        <h3 style="color:#2C2D5F;margin-bottom:8px;">
                        ${r.kind === "sos" ? "üö® SOS" : "ü©π –°–∏–º–ø—Ç–æ–º—ã"} ‚Ä¢ ${r.status}
                        </h3>
                        <p style="color:#666;font-size:13px;margin-bottom:12px;">
                        ${fmtLocal(r.created_at)}
                        </p>
                        ${(r.status === "accepted" || r.status === "in_progress" || r.status === "completed") && (r.volunteer_name || r.volunteer_phone) ? `
                        <div class="alert-box info" style="margin-top:12px;">
                            <strong>–í–æ–ª–æ–Ω—Ç—ë—Ä –ø—Ä–∏–Ω—è–ª –∑–∞—è–≤–∫—É</strong><br>
                            ${r.volunteer_name ? `üë§ ${r.volunteer_name}<br>` : ""}
                            ${r.volunteer_phone ? `üìû ${r.volunteer_phone}` : ""}
                            ${vRating ? `
                                <div style="margin-top:8px;color:#1565C0;">
                                    ‚≠ê –†–µ–π—Ç–∏–Ω–≥ –≤–æ–ª–æ–Ω—Ç—ë—Ä–∞: <strong>${vRating.avg_rating.toFixed(1)}</strong> / 5
                                    <span style="color:#666;">(${vRating.reviews_count} –æ—Ç–∑—ã–≤–æ–≤)</span>
                                </div>
                            ` : ``}
                            ${r.accepted_by ? `
                                <button class="btn btn-primary"
                                    style="width:100%; margin-top:10px;"
                                    onclick="openVolunteerProfile(${r.accepted_by}, '${(r.volunteer_name || "–í–æ–ª–æ–Ω—Ç—ë—Ä").replace(/'/g, "\\'")}')">
                                    ‚≠ê –ü—Ä–æ—Ñ–∏–ª—å –≤–æ–ª–æ–Ω—Ç—ë—Ä–∞
                                </button>
                            ` : ``}
                        </div>
                    ` : ""}

                    ${(r.address || (r.lat != null && r.lng != null)) ? `
                        <div class="card" style="margin-top:12px;">
                            <p style="font-weight:600;color:#2C2D5F;margin-bottom:8px;">üìç –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</p>
                            ${r.address ? `<p style="color:#555;font-size:14px;margin-bottom:6px;"><strong>–ê–¥—Ä–µ—Å:</strong> ${r.address}</p>` : ``}
                            ${(r.lat != null && r.lng != null) ? `
                                <p style="color:#555;font-size:14px;"><strong>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</strong> ${r.lat.toFixed(6)}, ${r.lng.toFixed(6)}</p>
                            ` : ``}
                        </div>
                    ` : ``}


                        
                        
                        ${reaction_minutes != null ? `
                            <div class="alert-box info" style="margin-top:12px;">
                                ‚úÖ –í–æ–ª–æ–Ω—Ç—ë—Ä –æ—Ç–∫–ª–∏–∫–Ω—É–ª—Å—è –∑–∞ <strong>${reaction_minutes}</strong> –º–∏–Ω.
                                ${r.volunteer_phone ? `<div style="margin-top:8px;">
                                <button class="btn btn-primary" style="width:100%;" onclick="window.location.href='tel:${r.volunteer_phone}'">
                                    üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å –≤–æ–ª–æ–Ω—Ç—ë—Ä—É
                                </button>
                                </div>` : ``}
                            </div>
                            ` : `
                            <div class="alert-box info" style="margin-top:12px;">
                                ‚è≥ –ò—â–µ–º –≤–æ–ª–æ–Ω—Ç—ë—Ä–∞‚Ä¶ (–∑–∞—è–≤–∫–∞ –µ—â—ë –Ω–µ –ø—Ä–∏–Ω—è—Ç–∞)
                            </div>
                            `}
                        ${r.symptoms ? `<p style="margin-bottom:8px;"><strong>–°–∏–º–ø—Ç–æ–º—ã:</strong><br>${r.symptoms}</p>` : ""}
                        ${r.comments ? `<p style="margin-bottom:12px;"><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong><br>${r.comments}</p>` : ""}

                        <div class="card" style="margin-top:12px;">
                            <p style="font-weight:600;color:#2C2D5F;margin-bottom:8px;">–¢–∞–π–º–ª–∞–π–Ω</p>
                            <p style="color:#666;font-size:13px;">–°–æ–∑–¥–∞–Ω–æ: ${fmtLocal(r.created_at)}</p>
                            ${r.accepted_at ? `<p style="color:#666;font-size:13px;">–ü—Ä–∏–Ω—è—Ç–æ: ${fmtLocal(r.accepted_at)}</p>` : ``}
                            ${r.in_progress_at ? `<p style="color:#666;font-size:13px;">–í —Ä–∞–±–æ—Ç–µ: ${fmtLocal(r.in_progress_at)}</p>` : ``}
                            ${r.completed_at ? `<p style="color:#666;font-size:13px;">–ó–∞–≤–µ—Ä—à–µ–Ω–æ: ${fmtLocal(r.completed_at)}</p>` : ``}
                            ${r.canceled_at ? `<p style="color:#666;font-size:13px;">–û—Ç–º–µ–Ω–µ–Ω–æ: ${fmtLocal(r.canceled_at)}</p>` : ``}
                        </div>

                        <div id="userEtaBox"></div>



                        ${(r.status === "new") ? `
                            <div style="display:flex; gap:8px; margin-top:16px;">
                                <button type="button" class="btn btn-outline"
                                    style="flex:1; border-color:#B91717; color:#B91717;"
                                    onclick="setRequestStatus('canceled')">
                                    –û—Ç–º–µ–Ω–∏—Ç—å
                                </button>
                            </div>
                        ` : ``}

                        



                            ${(r.status === "completed" && r.rating == null) ? `
                            <div class="card" style="margin-top:12px;">
                                <p style="font-weight:600;color:#2C2D5F;margin-bottom:8px;">–û—Ü–µ–Ω–∏—Ç–µ –≤–æ–ª–æ–Ω—Ç—ë—Ä–∞</p>

                                <div class="input-group">
                                <label class="input-label">–û—Ü–µ–Ω–∫–∞ (1‚Äì5)</label>
                                <input id="reviewRating" type="number" min="1" max="5" class="input-field" placeholder="5">
                                </div>

                                <div class="input-group">
                                <label class="input-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                                <textarea id="reviewText" class="textarea-field" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ø—Ä–∏–µ—Ö–∞–ª –±—ã—Å—Ç—Ä–æ, –ø–æ–º–æ–≥..." ></textarea>
                                </div>

                                <button class="btn btn-primary" style="width:100%;" onclick="submitReview(${r.id})">
                                ‚≠ê –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
                                </button>
                            </div>
                            ` : ``}

                            ${(r.status === "completed" && r.rating != null) ? `
                            <div class="alert-box info" style="margin-top:12px;">
                                ‚≠ê –í–∞—à –æ—Ç–∑—ã–≤: <strong>${r.rating}/5</strong><br>
                                ${r.review_text ? `üí¨ ${r.review_text}` : ``}
                            </div>
                            ` : ``}

                    `;
                    } catch (e) {
                    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ—Ç–∞–ª–∏: " + e.message);
                    navigateTo("myRequests");
                    }

                    const etaBox = document.getElementById("userEtaBox");

                    const userLat = r.lat;
                    const userLng = r.lng;
                    const volLat = r.volunteer_lat;
                    const volLng = r.volunteer_lng;

                    if (etaBox) {
                    if (userLat != null && userLng != null && volLat != null && volLng != null && (r.status === "accepted" || r.status === "in_progress")) {
                        etaBox.innerHTML = `<div class="alert-box info">üß≠ –°—á–∏—Ç–∞–µ–º –≤—Ä–µ–º—è –ø—Ä–∏–±—ã—Ç–∏—è –≤–æ–ª–æ–Ω—Ç—ë—Ä–∞‚Ä¶</div>`;
                        try {
                        const eta = await osrmEta(volLat, volLng, userLat, userLng);
                        if (eta) {
                            etaBox.innerHTML = `<div class="alert-box info">üöó –í–æ–ª–æ–Ω—Ç—ë—Ä –±—É–¥–µ—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ —á–µ—Ä–µ–∑ <strong>${eta.minutes}</strong> –º–∏–Ω ‚Ä¢ ${eta.km} –∫–º</div>`;
                        } else {
                            etaBox.innerHTML = `<div class="alert-box info">üöó –í–æ–ª–æ–Ω—Ç—ë—Ä –≤ –ø—É—Ç–∏ (ETA –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ)</div>`;
                        }
                        } catch (e) {
                        etaBox.innerHTML = `<div class="alert-box info">üöó –í–æ–ª–æ–Ω—Ç—ë—Ä –≤ –ø—É—Ç–∏ (ETA –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ)</div>`;
                        }
                    } else {
                        etaBox.innerHTML = ``;
                    }
                }

                
                
            })();
            
            startUserEta(appState.selectedRequestId);


                


            }


        }

        
        function selectCategory(categoryId) {
            appState.selectedCategory = categoryId;
            navigateTo('category-detail');
        }

        function selectVideo(videoId) {
            appState.selectedVideoId = videoId;
            navigateTo('video-detail');
        }
        
        async function acceptOpenRequest(id) {
            console.log("acceptOpenRequest clicked:", id);

            try {
                const accepted = await api(`/requests/${id}/accept`, "POST", null, true);

                const rid = accepted?.id || accepted?.request_id || accepted?.request?.id || id;

                setSelectedRequestId(rid);
                appState.selectedRequestId = rid;

                navigateTo("volunteer-map", "accepted from volunteer-open");

                (async () => {
                    try {
                        const geo = await getGeo();
                        if (geo.lat == null || geo.lng == null) return;

                        await api(`/volunteer/requests/${rid}/location`, "PATCH", {
                            volunteer_lat: geo.lat,
                            volunteer_lng: geo.lng
                        }, true);
                    } catch (e) {
                        console.warn("Location PATCH failed:", e.message);
                    }
                })();

            } catch (e) {
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–Ω—è—Ç—å –∑–∞—è–≤–∫—É: " + e.message);
            }
        }







        


        async function showSOS() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å?\n\n–ë–ª–∏–∂–∞–π—à–∏–µ –≤–æ–ª–æ–Ω—Ç–µ—Ä—ã –±—É–¥—É—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω—ã –æ –≤–∞—à–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏.')) return;

            try {
                const geo = await getGeo();
                appState.lastRequestLat = geo.lat;
                appState.lastRequestLng = geo.lng;
                const address = prompt("–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):", "") || "";

                const created = await api("/requests", "POST", {
                    kind: "sos",
                    lat: geo.lat,
                    lng: geo.lng,
                    address: address.trim()
                }, true);

                const rid = created?.id || created?.request_id || (created?.request && created.request.id) || 0;
                setSelectedRequestId(rid);


                console.log("created request id:", appState.selectedRequestId);
                console.log("token:", getToken());


                navigateTo('volunteer-map');
            } catch (err) {
                alert("–û—à–∏–±–∫–∞ SOS: " + err.message);
            }
        }

        function zoomMap(direction) {
            const maps = ['mapImage', 'volunteerMapImage'];
            maps.forEach(mapId => {
                const map = document.getElementById(mapId);
                if (map) {
                    if (direction === 'in') {
                        appState.mapZoom = Math.min(appState.mapZoom + 0.2, 2);
                    } else {
                        appState.mapZoom = Math.max(appState.mapZoom - 0.2, 0.5);
                    }
                    map.style.transform = `scale(${appState.mapZoom})`;
                }
            });
        }

        function getBotResponse(userMessage) {
            const message = userMessage.toLowerCase().trim();
            
            
            for (const [keyword, response] of Object.entries(botResponses)) {
                if (keyword !== 'default' && message.includes(keyword)) {
                    return response;
                }
            }
            
            return botResponses.default;
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            if (input && input.value.trim()) {
                const userMessage = input.value.trim();
                
                
                appState.chatMessages.push({
                    type: 'user',
                    text: userMessage
                });
                
                
                const botMessage = getBotResponse(userMessage);
                
                
                setTimeout(() => {
                    appState.chatMessages.push({
                        type: 'bot',
                        text: botMessage
                    });
                    renderScreen('chat');
                }, 500);
                
                input.value = '';
                renderScreen('chat');
            }
        }

        function toggleNotification(type) {
            appState.notifications[type] = !appState.notifications[type];
            renderScreen('notifications');
        }

        function selectLanguage(code) {
            appState.selectedLanguage = code;
            renderScreen('language');
            setTimeout(() => {
                alert('–Ø–∑—ã–∫ –∏–∑–º–µ–Ω–µ–Ω! –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤—Å—Ç—É–ø—è—Ç –≤ —Å–∏–ª—É –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.');
            }, 300);
        }

        function logout() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?')) {
                clearToken();
                appState.userName = '';
                appState.userEmail = '';
                appState.userPhone = '';
                appState.userRole = "user";


                navigateTo('auth');
            }
        }
        function openRequest(id) {
            console.log("openRequest", id);
            setSelectedRequestId(id);
            navigateTo("requestDetail");

        }

        function openMyActiveMap() {
            const id = Number(appState.selectedRequestId || loadSelectedRequestId() || 0);
            if (!id) {
                alert("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –∑–∞—è–≤–∫–∏. –°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∑–∞–ø—Ä–æ—Å (SOS –∏–ª–∏ —Å–∏–º–ø—Ç–æ–º—ã).");
                return;
            }
            setSelectedRequestId(id);
            navigateTo("volunteer-map");
        }






        async function setRequestStatus(status) {
            try {
                const id = appState.selectedRequestId;
                await api(`/requests/${id}/status`, "PATCH", { status }, true);
                navigateTo("myRequests");
            } catch (e) {
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å: " + e.message);
            }
        }
        async function submitReview(id) {
        const ratingRaw = document.getElementById("reviewRating").value;
        const review_text = (document.getElementById("reviewText").value || "").trim();

        const rating = ratingRaw === "" ? 5 : parseInt(ratingRaw, 10);

        if (!(rating >= 1 && rating <= 5)) {
            alert("–û—Ü–µ–Ω–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 1 –¥–æ 5");
            return;
        }

        try {
            await api(`/requests/${id}/review`, "POST", { rating, review_text }, true);
            alert("–û—Ç–∑—ã–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ‚úÖ");
            appState.selectedRequestId = id;
            navigateTo("requestDetail"); 
        } catch (e) {
            alert("–û—à–∏–±–∫–∞ –æ—Ç–∑—ã–≤–∞: " + e.message);
        }
        }





        
        function openVolunteerRequest(id) {
            appState.selectedRequestId = id;
            navigateTo("volunteer-request");
        }

        async function volSetStatus(status, stayOnCurrentScreen = false) {
            try {
                const id = appState.selectedRequestId;
                await api(`/volunteer/requests/${id}/status`, "PATCH", { status }, true);

                if (stayOnCurrentScreen) {
                    if (appState.currentScreen === "volunteer-map") {
                        await loadVolunteerMap();
                    } else if (appState.currentScreen === "volunteer-request") {
                        renderScreen("volunteer-request");
                    } else {
                        renderScreen(appState.currentScreen || "home");
                    }
                    return;
                }

                navigateTo("volunteer-my");
            } catch (e) {
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å: " + e.message);
            }
        }


        function fmtTime(dt) {
            return fmtLocal(dt);
        }


        function fmtMinutes(ms) {
            const m = Math.round(ms / 60000);
            if (m <= 0) return "–º–µ–Ω—å—à–µ –º–∏–Ω—É—Ç—ã";
            return m + " –º–∏–Ω";
        }
        let pollTimer = null;

        function stopPolling() {
            if (pollTimer) {
                clearInterval(pollTimer);
                pollTimer = null;
            }
        }
        function stopUserEta() {
            if (userEtaTimer) {
                clearInterval(userEtaTimer);
                userEtaTimer = null;
            }
        }


        function startPolling(fn, intervalMs = 10000) {
            stopPolling();

            const safeRun = async () => {
                if (pollInFlight) return;
                pollInFlight = true;
                try { await fn(); }
                finally { pollInFlight = false; }
            };

            safeRun();
            pollTimer = setInterval(safeRun, intervalMs);
        }


        function renderStars(rating) {
            const full = Math.floor(rating);
            const empty = 5 - full;
            return "‚òÖ".repeat(full) + "‚òÜ".repeat(empty);
        }
        

        async function loadReviewsStats() {
            return await api("/reviews/stats", "GET", null, false);
        }


        function vmInitMap(lat, lng) {
            if (vmMap) return;

            vmMap = L.map("vmLeaflet", { zoomControl: true }).setView([lat, lng], 15);

            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                maxZoom: 19,
                attribution: "&copy; OpenStreetMap"
            }).addTo(vmMap);

            setTimeout(() => {
                if (vmMap) vmMap.invalidateSize(true);
            }, 100);
        }


        function vmSetUser(lat, lng, text = "–í—ã") {
            if (!vmMap) vmInitMap(lat, lng);

            if (!vmUserMarker) {
                vmUserMarker = L.circleMarker([lat, lng], {
                radius: 10,
                weight: 3,
                fillOpacity: 0.9
                }).addTo(vmMap);
            } else {
                vmUserMarker.setLatLng([lat, lng]);
            }

            vmUserMarker.bindPopup(`üìç ${text}`);
        }

        function vmSetVolunteer(lat, lng, name = "–í–æ–ª–æ–Ω—Ç—ë—Ä") {
            if (!vmMap) return;

            if (!vmVolMarker) {
                vmVolMarker = L.circleMarker([lat, lng], {
                radius: 10,
                color: "#16a34a",       
                fillColor: "#22c55e",
                weight: 3,
                fillOpacity: 0.9
                }).addTo(vmMap);
            } else {
                vmVolMarker.setLatLng([lat, lng]);
            }

            vmVolMarker.bindPopup(`üßë‚Äç‚öïÔ∏è ${name}`);
        }

        function vmFitOnce(userLat, userLng, volLat, volLng) {
            const key = `${userLat},${userLng}|${volLat ?? ""},${volLng ?? ""}`;
            if (vmLastFitKey === key) return;

            if (!vmMap) return;

            if (volLat != null && volLng != null) {
                const bounds = L.latLngBounds(
                L.latLng(userLat, userLng),
                L.latLng(volLat, volLng)
                );
                vmMap.fitBounds(bounds, { padding: [30, 30] });
            } else {
                vmMap.setView([userLat, userLng], 15);
            }

            vmLastFitKey = key;
        }



        function vmOpenRoute(userLat, userLng, volLat, volLng, address) {
            if (volLat != null && volLng != null) {
                window.open(`https://www.google.com/maps/dir/?api=1&origin=${volLat},${volLng}&destination=${userLat},${userLng}`, "_blank");
                return;
            }


            window.open(`https://www.google.com/maps?q=${userLat},${userLng}`, "_blank");
        }

        function vmDrawRoute(userLat, userLng, volLat, volLng) {
            if (!vmMap) return;
            if (volLat == null || volLng == null || userLat == null || userLng == null) return;

            const key = `${volLat},${volLng}->${userLat},${userLng}`;
            if (vmRouteKey === key) return;

            if (vmRoute) {
                vmMap.removeControl(vmRoute);
                vmRoute = null;
            }

            vmRoute = L.Routing.control({
                waypoints: [
                L.latLng(volLat, volLng),
                L.latLng(userLat, userLng)
                ],
                addWaypoints: false,
                draggableWaypoints: false,
                fitSelectedRoutes: false,
                show: false,
                lineOptions: {
                styles: [
                    { color: "#2E7D32", weight: 5, opacity: 0.8 } 
                ]
                },
                router: L.Routing.osrmv1({
                serviceUrl: "https://router.project-osrm.org/route/v1"
                })
            })
            .on("routesfound", (e) => {
                const route = e.routes?.[0];
                if (!route) return;

                const sec = route.summary?.totalTime;
                const meters = route.summary?.totalDistance;

                if (sec != null) {
                const etaMin = Math.max(1, Math.round(sec / 60));
                const km = meters != null ? (meters / 1000).toFixed(1) : null;

                const el = document.getElementById("vmEta");
                if (el) {
                el.innerHTML = `
                    <div class="alert-box info">
                        üìç ${etaMin} –º–∏–Ω ‚Ä¢ ${km ? `${km} –∫–º` : ""}
                    </div>
                    `;
                }
                }
            })
            .addTo(vmMap);

            vmRouteKey = key;
        }


        function vmFocusAll() {
            if (!vmMap) return;

            const pts = [];
            if (vmUserMarker) pts.push(vmUserMarker.getLatLng());
            if (vmVolMarker) pts.push(vmVolMarker.getLatLng());

            if (pts.length === 2) {
                vmMap.fitBounds(L.latLngBounds(pts[0], pts[1]), { padding: [30, 30] });
            } else if (pts.length === 1) {
                vmMap.setView(pts[0], 15);
            }
        }

        function hmInitMap(lat, lng) {
            if (hmMap) return;

            hmMap = L.map("hmLeaflet", { zoomControl: true }).setView([lat, lng], 14);

            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                maxZoom: 19,
                attribution: "&copy; OpenStreetMap"
            }).addTo(hmMap);

            setTimeout(() => {
                if (hmMap) hmMap.invalidateSize(true);
            }, 100);
        }

        function hmSetUser(lat, lng) {
            if (!hmMap) hmInitMap(lat, lng);

            if (!hmUserMarker) {
                hmUserMarker = L.circleMarker([lat, lng], {
                    radius: 9,
                    color: "#2563eb",
                    fillColor: "#3b82f6",
                    weight: 3,
                    fillOpacity: 0.9
                }).addTo(hmMap);
            } else {
                hmUserMarker.setLatLng([lat, lng]);
            }

            hmUserMarker.bindPopup("üìç –í—ã –∑–¥–µ—Å—å");
        }

        function hmSetHospitals(items) {
            if (!hmMap) return;

            if (hmHospitalLayer) {
                hmHospitalLayer.remove();
                hmHospitalLayer = null;
            }

            hmHospitalLayer = L.layerGroup();
            items.forEach((x) => {
                const m = L.circleMarker([x.lat, x.lng], {
                    radius: 9,
                    color: "#16a34a",
                    fillColor: "#22c55e",
                    weight: 3,
                    fillOpacity: 0.9
                });

                const addr = x.address ? `<br>${x.address}` : "";
                const phone = x.phone ? `<br>üìû ${x.phone}` : "";

                m.bindPopup(`<strong>üè• ${x.name}</strong>${addr}${phone}`);
                hmHospitalLayer.addLayer(m);
            });

            hmHospitalLayer.addTo(hmMap);
        }

        function hmFitAll(userLat, userLng, items) {
            if (!hmMap) return;

            const pts = [];
            if (userLat != null && userLng != null) pts.push(L.latLng(userLat, userLng));
            for (const x of items) pts.push(L.latLng(x.lat, x.lng));

            if (pts.length >= 2) {
                hmMap.fitBounds(L.latLngBounds(pts), { padding: [30, 30] });
            } else if (pts.length === 1) {
                hmMap.setView(pts[0], 14);
            }
        }

        function haversineKm(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const toRad = (x) => x * Math.PI / 180;

            const dLat = toRad(lat2 - lat1);
            const dLng = toRad(lng2 - lng1);

            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);

            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function hmRenderList(userLat, userLng, items) {
            const box = document.getElementById("hmList");
            if (!box) return;

            let list = items.slice();

            if (userLat != null && userLng != null) {
                list = list.map(x => ({
                    ...x,
                    km: haversineKm(userLat, userLng, x.lat, x.lng)
                })).sort((a, b) => a.km - b.km);
            }

            if (!list.length) {
                box.innerHTML = `<div class="card">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —Ä—è–¥–æ–º.</div>`;
                return;
            }

            box.innerHTML = list.slice(0, 12).map(x => `
                <div class="card mb-3">
                    <div style="display:flex;justify-content:space-between;gap:10px;margin-bottom:10px;">
                        <div style="flex:1;">
                            <h4 class="text-primary" style="font-weight:700;margin-bottom:4px;">${x.name}</h4>
                            ${x.address ? `<div style="color:#666;font-size:13px;">${x.address}</div>` : `<div style="color:#999;font-size:13px;">–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω</div>`}
                        </div>
                        ${x.km != null ? `<span style="background:#E8F5E9;color:#2E7D32;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:700;height:fit-content;">${x.km.toFixed(1)} –∫–º</span>` : ""}
                    </div>

                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-primary" style="flex:1;padding:12px;" onclick="window.open('https://www.google.com/maps?q=${x.lat},${x.lng}','_blank')">
                            üó∫Ô∏è –ú–∞—Ä—à—Ä—É—Ç
                        </button>
                        ${x.phone ? `
                            <button class="btn btn-outline" style="flex:1;padding:12px;" onclick="callPhone('${String(x.phone).replace(/'/g,"\\'")}')">
                                üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å
                            </button>
                        ` : `
                            <button class="btn btn-outline" style="flex:1;padding:12px;" disabled>
                                üìû –ù–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞
                            </button>
                        `}
                    </div>
                </div>
            `).join("");
        }



        

        function stopVolunteerGeo() {
            if (volGeoTimer) {
                clearInterval(volGeoTimer);
                volGeoTimer = null;
            }
        }

        function startVolunteerGeo() {
            stopVolunteerGeo();

            const tick = async () => {
                try {
                    if (appState.userRole !== "volunteer") return;

                    const id = appState.selectedRequestId;
                    if (!id) return;

                    const geo = await getGeo();
                    if (geo.lat == null || geo.lng == null) return;

                    await api(`/volunteer/requests/${id}/location`, "PATCH", {
                        volunteer_lat: geo.lat,
                        volunteer_lng: geo.lng
                    }, true);
                } catch (e) {}
            };

            tick();
            volGeoTimer = setInterval(tick, 10000);
        }

        async function osrmEta(lat1, lng1, lat2, lng2) {
            const url = `https://router.project-osrm.org/route/v1/driving/${lng1},${lat1};${lng2},${lat2}?overview=false`;
            const res = await fetch(url);
            const data = await res.json();

            const r = data?.routes?.[0];
            if (!r) return null;

            const minutes = Math.max(1, Math.round(r.duration / 60));
            const km = (r.distance / 1000).toFixed(1);
            return { minutes, km };
        }
        function startUserEta(requestId) {
            stopUserEta();

            const tick = async () => {
                try {
                const r = await api(`/requests/${requestId}/track`, "GET", null, true);

                const userLat = r.lat;
                const userLng = r.lng;
                const volLat = r.volunteer_lat;
                const volLng = r.volunteer_lng;

                const box = document.getElementById("userEtaBox");
                if (!box) return;

                if (
                    userLat == null || userLng == null ||
                    volLat == null || volLng == null ||
                    !(r.status === "accepted" || r.status === "in_progress")
                ) {
                    box.innerHTML = "";
                    return;
                }

                box.innerHTML = `<div class="alert-box info">üß≠ –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø—Ä–∏–±—ã—Ç–∏—è‚Ä¶</div>`;

                const eta = await osrmEta(volLat, volLng, userLat, userLng);
                if (!eta) return;

                box.innerHTML = `
                    <div class="alert-box info">
                    üöó –í–æ–ª–æ–Ω—Ç—ë—Ä –±—É–¥–µ—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ —á–µ—Ä–µ–∑ <strong>${eta.minutes}</strong> –º–∏–Ω ‚Ä¢ ${eta.km} –∫–º
                    </div>
                `;
                } catch (e) {}
            };

            tick();
            userEtaTimer = setInterval(tick, 10000);
        }


        async function fetchNearbyHospitalsOSM(lat, lng, radiusMeters = 5000, limit = 30) {
            const query = `
        [out:json][timeout:25];
        (
        node["amenity"="hospital"](around:${radiusMeters},${lat},${lng});
        way["amenity"="hospital"](around:${radiusMeters},${lat},${lng});
        relation["amenity"="hospital"](around:${radiusMeters},${lat},${lng});

        node["amenity"="clinic"](around:${radiusMeters},${lat},${lng});
        way["amenity"="clinic"](around:${radiusMeters},${lat},${lng});
        relation["amenity"="clinic"](around:${radiusMeters},${lat},${lng});
        );
        out center tags;
        `;

            const url = "https://overpass-api.de/api/interpreter";
            const res = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "text/plain;charset=UTF-8" },
                body: query
            });

            const data = await res.json();
            const els = data.elements || [];

            const items = els.map((e) => {
                const name = e.tags?.name || e.tags?.["name:ru"] || e.tags?.["name:en"] || "–ë–æ–ª—å–Ω–∏—Ü–∞/–∫–ª–∏–Ω–∏–∫–∞";
                const phone = e.tags?.phone || e.tags?.["contact:phone"] || "";
                const address = [
                    e.tags?.["addr:city"],
                    e.tags?.["addr:street"],
                    e.tags?.["addr:housenumber"]
                ].filter(Boolean).join(", ");

                const pLat = e.type === "node" ? e.lat : e.center?.lat;
                const pLng = e.type === "node" ? e.lon : e.center?.lon;

                if (pLat == null || pLng == null) return null;

                return {
                    id: `${e.type}-${e.id}`,
                    name,
                    address,
                    phone,
                    lat: pLat,
                    lng: pLng
                };
            }).filter(Boolean);

            const uniq = new Map();
            for (const x of items) {
                const key = `${x.lat.toFixed(6)},${x.lng.toFixed(6)}|${x.name}`;
                if (!uniq.has(key)) uniq.set(key, x);
            }

            return Array.from(uniq.values()).slice(0, limit);
        }







        async function geocodeAddress(address) {
            const q = (address || "").trim();
            if (!q) return null;

            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`;
            const res = await fetch(url, { headers: { "Accept": "application/json" } });
            const data = await res.json();

            if (!Array.isArray(data) || !data.length) return null;

            return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
        }


        function callPhone(phone) {
            const p = (phone || "").toString().trim();
            if (!p) return;
            window.location.href = "tel:" + p;
        }


        function fmtLocal(dt) {
            if (!dt) return "‚Äî";
            const d = (dt instanceof Date) ? dt : new Date(dt);
            if (isNaN(d.getTime())) return "‚Äî";
            return d.toLocaleString(undefined, {
                year: "numeric",
                month: "2-digit",
                day: "2-digit",
                hour: "2-digit",
                minute: "2-digit"
            });
        }









    </script>
</body>
</html>
